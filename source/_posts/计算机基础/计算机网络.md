---
title: 计算机网络
date: 2022-08-05 16:46:41
tags: 
- 计算机网络
categories:
- 计算机基础
---


**图示说明**

![image-20220805140346130](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805140346130.png)代表着主机

![image-20220805140354725](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805140354725.png)代表服务器

![image-20220805140402637](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805140402637.png) 代表着路由器

![image-20220805140412100](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805140412100.png)代表着网络

# 概述

### 计算机网络在信息时代的作用

* 计算机网络已由一种**通信基础设施**发展成为一种重要的**信息服务基础设施**
* 计算机网络已经像水，电，煤气这些基础设施一样，成为我们**生活中不可或缺**的一部分

#### 我国互联网发展状况

[中国互联网络信息中心CNNIC](http://www.cnnic.net.cn)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-762604e225775be9.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-67cef530fb12b5d9.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dbf8fb050bcdbf8b.png)



------



## 因特网概述

### 网络、互连网（互联网）和因特网（理解）

网络：网络（Network）由若干**结点（Node）**和连接这些结点的**链路（Link）**组成。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4fcd41d225b201be.png)

互连网（互联网）：多个网络通过路由器互连起来，这样就构成了一个覆盖范围更大的网络，即互连网（互联网）。因此，互联网又称为“网络的网络（Network of Networks）”。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ff49fa2ef0245745.png)

因特网：因特网（Internet）是世界上最大的互连网络（用户数以亿计，互连的网络数以百万计）。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ee181b01ca4c6f8e.png)

> **internet与Internet的区别**
>
> * **internet(互联网或互连网)**是一个通用名词，它泛指**多个计算机网络互连而成的网络**。在这些网络之间的通信协议可以是任意的。
> * **Internet（因特网）则是一个专用名词**，它指**当前全球最大的、开放的、由众多网络互连而成的特定计算机网络**，它采用TCP/IP协议族作为通信的规则，其前身是美国的ARPANET。
>
> **任意把几个计算机网络互连起来（不管采用什么协议），并能够相互通信，这样构成的是一个互连网(internet) ，而不是互联网(Internet)。**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-cb6c0dd7a1f70e3e.png)



### 因特网发展的三个阶段

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0ee6522bfae940b5.png)



**因特网服务提供者`ISP`(`I`nternet `S`ervice `P`rovider)**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-332e68bc46bc59ab.png)

> 普通用户是如何接入到因特网的呢？
>
> 答：**通过ISP接入因特网**
>
> ISP可以从因特网管理机构申请到成块的IP地址，同时拥有通信线路以及路由器等联网设备。任何机构和个人只需缴纳费用，就可从**ISP的得到所需要的IP地址**。
>
> **因为因特网上的主机都必须有IP地址才能进行通信，这样就可以通过该ISP接入到因特网**



**中国的三大`ISP`：中国电信，中国联通和中国移动**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ce38a42cfcab9872.png)



**基于ISP的三层结构的因特网**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1ccdf3defcff4ef1.png)

> 一旦某个用户能够接入到因特网，那么他也可以成为一个ISP，所需要做的就是购买一些如调制解调器或路由器这样的设备，让其他用户可以和他相连。



### 因特网的标准化工作

* 因特网的标准化工作对因特网的发展起到了非常重要的作用。
* 因特网在指定其标准上的一个很大的特点是**面向公众。**
  * 因特网所有的**RFC**(Request For Comments)技术文档都可从因特网上免费下载；
  * 任何人都可以随时用电子邮件发表对某个文档的意见或建议。
* **因特网协会ISOC**是一个国际性组织，它负责对因特网进行全面管理，以及在世界范围内促进其发展和使用。
  * 因特网体系结构委员会IAB，负责管理因特网有关协议的开发；
  * 因特网工程部IETF，负责研究中短期工程问题，主要针对协议的开发和标准化；
  * 因特网研究部IRTF，从事理论方面的研究和开发一些需要长期考虑的问题。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-92960e033eb18c8d.png)

* 制订因特网的正式标准要经过一下**4个阶段**：

  1、因特网草案（在这个阶段还不是RFC文档）

  2、建议标准（从这个阶段开始就成为RFC文档）

  3、草案标准

  4、因特网标准



### 因特网的组成

* 边缘部分

  由所有连接在因特网上的**主机**组成（台式电脑，大型服务器，笔记本电脑，平板，智能手机等）。这部分是**用户直接使用**的，用来进行**通信**（传送数据、音频或视频）和**资源共享**。

* 核心部分

  由**大量网络**和连接这些网络的**路由器**组成。这部分是**为边缘部分提供服务**的（提供连通性和交换）。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-3065474a4377aff0.png)

> 路由器是一种专用计算机，但我们不称它为主机，路由器是实现分组交换的关键构建，其任务是转发收到的分组，这是网络核心最重要的部分。
>
> 处在互联网边缘的部分就是连接在互联网上的所有的主机。这些主机又称为**端系统 (end system)**。
>
> **端系统在功能上可能有很大的差别：**
>
> 1. 小的端系统可以是一台普通个人电脑，具有上网功能的智能手机，甚至是一个很小的网络摄像头。
>
> 2. 大的端系统则可以是一台非常昂贵的大型计算机。
>
> 3. 端系统的拥有者可以是个人，也可以是单位（如学校、企业、政府机关等），当然也可以是某个ISP。

#### 补充：

**端系统之间通信的含义**

“主机 A 和主机 B 进行通信”实际上是指：“运行在主机 A 上的某个程序和运行在主机 B 上的另一个程序进行通信”。**即“主机** **A** **的某个进程和主机** **B** **上的另一个进程进行通信”。简称为“计算机之间通信”。** 

端系统之间的通信方式通常可划分为两大类：

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4ee005d739f54581.png)

**客户-服务器方式：**

* 客户 (client) 和服务器 (server) 都是指通信中所涉及的两个应用进程。
* 客户 - 服务器方式所描述的是进程之间服务和被服务的关系。
* 客户是服务的请求方，服务器是服务的提供方。

> **服务请求方和服务提供方都要使用网络核心部分所提供的服务。**

**对等连接方式：**

* **对等连接** (peer-to-peer，简写为 **P2P** ) 是指两个主机在通信时并不区分哪一个是服务请求方还是服务提供方。
* 只要两个主机都运行了对等连接软件 ( P2P 软件) ，它们就可以进行**平等的、对等连接通信**。
* 双方都可以下载对方已经存储在硬盘中的共享文档。 



------



## 三种交换方式

网络核心部分是互联网中最复杂的部分。

网络中的核心部分要向网络边缘中的大量主机提供连通性，使边缘部分中的任何一个主机都能够向其他主机通信（即传送或接收各种形式的数据）。

在网络核心部分起特殊作用的是**路由器**(router)。

**路由器**是实现**分组交换** (packet switching) 的关键构件，其任务是**转发**收到的分组，这是网络核心部分最重要的功能。

### 电路交换（Circuit Switching）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-cbb94cf7d6bc6f8b.png)

> 传统两两相连的方式，当电话数量很多时，电话线也很多，就很不方便
>
> 所以要使得每一部电话能够很方便地和另一部电话进行通信，就应该使用一个**中间设备**将这些电话连接起来，这个中间设备就是**电话交换机**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-7ad293b2ca19158b.png)

* 电话交换机接通电话线的方式称为电路交换；

* 从通信资源的分配角度来看，交换（Switching）就是按照某种方式动态地分配传输线路的资源；

* 电路交换的三个步骤：

  1、建立连接（分配通信资源）

  2、通话（一直占用通信资源）

  3、释放连接（归还通信资源）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-acb87df045723236.png)

> 当使用电路交换来传送计算机数据时，其线路的传输效率往往很低。
>
> 这是因为计算机数据是突发式地出现在传输线路上的。
>
> 所以计算机通常采用的是**分组交换**，而不是线路交换



### 分组交换（Packet Switching）（※）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-c57bf61052cb33f0.png)

> 通常我们把表示**该消息的整块数据**成为一个**报文**。
>
> 在发送报文之前，先把较长的报文划分成一个个更小的**等长数据段**，在每一个数据段前面。加上一些由必**要的控制信息组成的首部**后，就构成一个分组，也可简称为“包”，相应地，首部也可称为“包头”。
>
> 首部包含了**分组的目的地址**
>
> 分组从源主机到目的主机，可走不同的路径。

发送方

* 构造分组
* 发送分组

路由器

* 缓存分组
* 转发分组
* 简称为“分组转发”

> 在路由器中的输入和输出端口之间没有直接连线。
>
> 路由器处理分组的过程是：
>
> 1. 把收到的分组先**放入缓存（暂时存储）；**
> 2. **查找转发表**，找出到某个目的地址应从哪个端口转发；
> 3. 把分组送到适当的端口**转发**出去。

接收方

* 接收分组
* 还原报文



### 报文交换（Message Switching）

报文交换中的交换结点也采用存储转发方式，但报文交换对报文的大小没有限制，这就要求交换结点需要较大的缓存空间。报文交换主要用于早期的电报通信网，现在较少使用，**通常被较先进的分组交换方式所取代**。



### 三种交换方式的对比

> 假设A，B，C，D是分组传输路径所要经过的4个结点交换机，纵坐标为时间

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-e655a213714d1871.png)

分析：

电路交换：

* 通信之前首先要建立连接；连接建立好之后，就可以使用已建立好的连接进行数据传送；数据传送后，需释放连接，以归还之前建立连接所占用的通信线路资源。

* 一旦建立连接，中间的各结点交换机就是直通形式的，比特流可以直达终点；

报文交换：

* 可以随时发送报文，而不需要事先建立连接；整个报文先传送到相邻结点交换机，全部存储下来后进行查表转发，转发到下一个结点交换机。
* 整个报文需要在各结点交换机上进行存储转发，由于不限制报文大小，因此需要各结点交换机都具有较大的缓存空间。

分组交换：

* 可以随时发送分组，而不需要事先建立连接。构成原始报文的一个个分组，依次在各结点交换机上存储转发。各结点交换机在发送分组的同时，还缓存接收到的分组。
* 构成原始报文的一个个分组，在各结点交换机上进行存储转发，相比报文交换，减少了转发时延，还可以避免过长的报文长时间占用链路，同时也有利于进行差错控制。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-c56f91f290cbc92b.png)



------



## 计算机网络的定义和分类

### 定义

* 计算机网络的精确定义并未统一
* 计算机网络的最简单的定义是：一些**互**相**连**接的、**自治**的计算机的**集合**。
  * 互连：是指计算机之间可以通过有线或无线的方式进行数据通信；
  * 自治：是指独立的计算机，他有自己的硬件和软件，可以单独运行使用；
  * 集合：是指至少需要两台计算机；
* 计算机网络的较好的定义是：计算机网络主要是由一些**通用的，可编程的硬件（一定包含有中央处理机CPU）互连**而成的，而这些硬件并非专门用来实现某一特定目的（例如，传送数据或视频信号）。这些可编程的硬件能够用来**传送多种不同类型的数据**，并能**支持广泛的和日益增长的应用**。
  * 计算机网络所连接的硬件，并不限于一般的计算机，而是包括了智能手机等智能硬件。
  * 计算机网络并非专门用来传送数据，而是能够支持很多种的应用（包括今后可能出现的各种应用）。



### 分类

**按交换技术分类：**

* 电路交换网络
* 报文交换网络
* 分组交换网络

**按使用者分类：**

* 公用网
* 专用网

**按传输介质分类：**

* 有线网络
* 无线网络

**按覆盖范围分类：**

* 广域网WAN（Wide Area Network）

作用范围通常为几十到几千公里，因而有时也称为远程网（long haul network）。广域网是互联网的核心部分，其任务是通过长距离（例如，跨越不同的国家）运送主机所发送的数据。

* 城域网MAN

作用范围一般是一个城市，可跨越几个街区甚至整个城市

* 局域网LAN

一般用微型计算机或工作站通过高速通信线路相连（速率通常在 10 Mbit/s 以上），但地理上范围较小（1 km 左右）

* 个域网PAN

就是在个人工作的地方把个人使用的电子设备用无线技术连接起来的网络。

**按拓扑结构分类：**

* 总线型网络

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4ed63e74d9ced719.png)

* 星型网络

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f6a1849bcc443935.png)

* 环形网络

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ca133aaaf8fe8659.png)

* 网状型网络

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d0d30cddc7356396.png)



------



## 计算机网络的性能指标

### 速率

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ba6c4e627a62c05e.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0c0d70a808407ca2.png)





### 带宽（※）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f4b18e0039f4a6c6.png)





### 吞吐量

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0910421c209252b1.png)

> 带宽1 Gb/s的以太网，代表其额定速率是1 Gb/s，这个数值也是该以太网的**吞吐量的绝对上限值**。因此，对于带宽1 Gb/s的以太网，可能实际吞吐量只有 700 Mb/s，甚至更低。
>
> 注意：吞吐量还可以用每秒传送的字节数或帧数表示



### 时延（※）

时延时指数据（一个报文或分组，甚至比特）从网络（或链路）的一端传送到另一端所需的时间。

网络时延由几部分组成：

* 发送时延

主机或路由器发送数据帧所需要的时间，也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间。

* 传播时延

电磁波在信道中传播一定的距离需要花费的时间。

* 处理时延

主机或路由器在收到分组时要花费一定时间进行处理

* 排队时延

分组在进过网络传输时，要经过许多路由器。但分组在进入路由器后要先在输入队列中排队等待处理。

> 有时会把排队时延看成**处理时延 一部分**
>
> 总时延 = 发送时延 + 传播时延 + 处理时延 （处理时延 + 排队时延）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5f9bf4982c20ad4f.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dd48cf5be5b2a7f7.png)

> 当处理时延忽略不计时，发送时延 和 传播时延谁占主导，要具体情况具体分析



### 时延带宽积

时延带宽积 = 传播时延 * 带宽

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-bdca296e77c59e48.png)



### 往返时间

互联网上的信息不仅仅单方向传输而是双向交互的。因此，我们有时很需要知道**双向交互一次所需的时间**。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-73f29eb38db9983c.png)



### 利用率（※）

利用率有**信道利用率**和**网络利用率**两种。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-62d6da59682ef67f.png)



### 丢包率

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f8fc02096f0952b7.png)



------



## 计算机网络体系结构（※）

### 常见的计算机网络体系结构

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b5174af1551d6cee.png)

> 如今用的最多的是TCP/IP体系结构，现今规模最大的、覆盖全球的、基于TCP/IP的互联网并未使用OSI标准。
>
> TCP/IP体系结构相当于将OSI体系结构的**物理层**和**数据链路层**合并为了**网络接口层**，并去掉了**会话层**和**表示层**。
>
> TCP/IP在网络层使用的协议是IP协议，IP协议的意思是网际协议，因此**TCP/IP体系结构的网络层称为网际层**

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f647ab572971d89a.png)

> 在用户主机的操作系统中，通常都带有符合TCP/IP体系结构标准的TCP/IP协议族。
>
> 而用于网络互连的路由器中，也带有符合TCP/IP体系结构标准的TCP/IP协议族。
>
> 只不过路由器一般只包含网络接口层和网际层。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6800e214b18c47c3.png)

> **网络接口层**：并没有规定具体内容，这样做的目的是可以互连全世界各种不同的网络接口，例如：有线的以太网接口，无线局域网的WIFI接口等。
>
> **网际层**：它的核心协议是IP协议。
>
> **运输层**：TCP和UDP是这层的两个重要协议。
>
> **应用层**：这层包含了大量的应用层协议，如 HTTP , DNS 等。

> **IP协议（网际层）**可以将不同的**网络接口（网络接口层）**进行互连，并向其上的**TCP协议和UDP协议（运输层）**提供网络互连服务
>
> 而**TCP协议**在享受IP协议提供的网络互连服务的基础上，可向**应用层的相应协议**提供**可靠**的传输服务。
>
> **UDP协议**在享受IP协议提供的网络互连服务的基础上，可向**应用层的相应协议**提供**不可靠**的传输服务。

> TCP/IP体系结构中最重要的是**IP协议**和**TCP协议**，因此用TCP和IP来表示整个协议大家族。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-82255e6c6d5f29bf.png)

> 教学时把TCP/IP体系结构的**网络接口层**分成了**物理层**和**数据链路层**



### 计算机网络体系结构分层的必要性

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-466a303e1e5cc42a.png)

**物理层问题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0274083e0bf0da85.png)

> 这图说明
>
> * 第一，严格来说，传输媒体并不属于物理层
> * 计算机传输的信号，并不是图示的方波信号
>
> 这样举例只是让初学者容易理解

**数据链路层问题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f0d9f2816d7bab9d.png)

**网络层问题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f55f86e0a78ffe23.png)

**运输层问题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-20174ff3821a739b.png)

>如何标识与网络通信相关的应用进程：一个分组到来，我们应该交给哪个进程处理呢？浏览器进程还是QQ进程

**应用层问题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-edab6d1f00b0ab15.png)

> 应用层该用什么方法（应用层协议）去解析数据

**总结**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-96bdae8525215011.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d29fee34f68a16b9.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1cf0ec9780d80019.png)



### 计算机网络体系结构分层思想举例

例子：主机的浏览器如何与Web服务器进行通信

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-33e3c614a6ac37d0.png)



**解析：**

主机和Web服务器之间基于网络的通信，实际上是主机中的**浏览器应用进程**与Web服务器中的**Web服务器应用进程**之间基于**网络的通信**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8c5d1b3fdc1b7111.png)



**体系结构的各层在整个过程中起到怎样的作用？**

**发送方发送**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ac36f7a9544dde9f.png)

> 第一步：
>
> * **应用层**按照HTTP协议的规定构建一个**HTTP请求报文**
> * 应用层将**HTTP请求报文**交付给**运输层**处理

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-cc2b73b1736d5809.png)

> 第二步：
>
> * **运输层**给**HTTP请求报文**添加一个**TCP首部**，使之成为**TCP报文段**
> * **TCP报文段的首部格式**作用是区分应用进程以及实现可靠传输
> * **运输层**将T**CP报文段**交付给**网络层**处理

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dc02183dcf759d9e.png)

> 第三步：
>
> * **网络层**给**TCP报文段**添加一个**IP首部**，使之成为**IP数据报**
> * **IP数据报的首部格式**作用是使**IP数据报**可以在互联网传输，也就是被路由器转发
> * **网络层**将**IP数据报**交付给**数据链路层**处理

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f8cf8ce4a6bfdb54.png)

> 第四步：
>
> * **数据链路层**给**IP数据报**添加一个**首部**和一个**尾部**，使之成为**帧**     （图示右边为首部，左边为尾部） 
> * 该**首部**的作用主要是为了让**帧**能够在一段链路上或一个网络上传输，能够被相应的目的主机接收
> * 该**尾部**的作用是让目的主机检查所接收到的**帧**是否有误码
> * **数据链路层**将**帧**交付给**物理层**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-e7285afa504bce0d.png)

> 第五步：
>
> * **物理层**先将**帧**看做是**比特流**，这里的网络N1假设是以太网，所以**物理层**还会给该**比特流**前面添加**前导码**
> * **前导码**的作用是为了让目的主机做好接收帧的准备
> * **物理层**将装有**前导码**的**比特流**变换成相应的**信号**发送给传输媒体

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8ffee68ffe58b8a1.png)

> 第六步：
>
> * **信号**通过**传输媒体**到达**路由器**



**路由器转发**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b9824f4625354b9b.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-09a0b27933c9895e.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6eace5a882cca26d.png)

> 在路由器中
>
> * **物理层**将**信号**变为**比特流**，然后去掉**前导码**后，将其交付给**数据链路层**
> * **数据链路层**将**帧**的**首部**和**尾部**去掉后，将其交付给**网络层**，这实际交付的是**IP数据报**
> * **网络层**解析**IP数据报**的**首部**，从中提取**目的网络地址**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-bc79de20a0c4b57c.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-33d09406bfc433e0.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-28228b60dd019bb5.png)

> 在路由器中
>
> * 提取**目的网络地址**后查找**自身路由表**。确定**转发端口**， 以便进行转发
> * **网络层**将**IP数据报**交付给**数据链路层**
> * **数据链路层**给**IP数据报**添加一个**首部**和一个**尾部**，使之成为**帧**
> * **数据链路层**将帧交付给**物理层**
> * **物理层**先将**帧**看成**比特流**，这里的网络N2假设是以太网，所以**物理层**还会给该**比特流**前面添加**前导码**
> * 物理层将装有**前导码**的**比特流**变换成相应的**信号**发送给传输媒体，信号通过传输媒体到达**Web服务器**



**接收方接收**

> 和发送方（主机）发送过程的封装正好是反着来
>
> 在Web 服务器上
>
> * **物理层**将**信号**变换为**比特流**，然后去掉**前导码**后成为**帧**，交付给**数据链路层**
> * **数据链路层**将**帧**的**首部**和**尾部**去掉后成为**IP数据报**，将其交付给**网络层**
> * **网络层**将**IP数据报**的**首部**去掉后成为**TCP报文段**，将其交付给**运输层**
> * **运输层**将**TCP报文段**的**首部**去掉后成为**HTTP请求报文**，将其交付给**应用层**
> * **应用层**对**HTTP请求报文**进行**解析**，然后给主机发回**响应报文**
>
> **发回响应报文的步骤和之前过程类似**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d9f5b6ce408c252b.png)



### 计算机网络体系结构中的专用术语

以下介绍的专用术语来源于OSI的七层协议体系结构，但也适用于TCP/IP的四层体系结构和五层协议体系结构

**实体**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b4c748c8f731e416.png)



**协议**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-01d621fd0afde0a2.png)

> 协议：控制两个对等实体进行逻辑通信的规则的集合
>
> 协议三要素：
>
> * 语法：定义所交换信息的格式
> * 语义：定义收发双方所要完成的操作
> * 同步：定义收发双发的时序关系



**服务**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b3d7eb63257d9914.png)

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b3d7eb63257d9914.png)



![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f9bd7898a7f2dadd.png)

## 习题

**时延**

![image-20220805164121227](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805164121227.png)

![image-20220805164016480](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805164016480.png)

![image-20220805164313974](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805164313974.png)

![image-20220805165029766](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805165029766.png)

![image-20220805170015674](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220805170015674.png)

# 物理层

## 物理层的基本概念（※）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-9b987d868b26c714.png)

------

## 物理层下面的传输媒体

**传输媒体**也称为传输介质或传输媒介，他就是数据传输系统中在发送器和接收器之间的物理通路。**传输媒体**课分为两大类，即**导引型传输媒体**和**非导引型传输媒体**

传输媒体不属于计算机网络体系结构的任何一层。如果非要将它添加到体系结构中，那只能将其放置到物理层之下。

### 导引型传输媒体

在导引型传输媒体中，电磁波被导引沿着固体媒体传播。

**同轴电缆**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-50d3acc8eff03935.png)

**双绞线**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-692dde0bbbc49a1d.png)

**光纤**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-fc85597b91c2cd7a.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-060d940d8451692e.png)

> **多模光纤**
>
> - 可以存在多条不同角度入射的光线在一条光纤中传输。这种光纤就称为**多模光纤**。
>
> **单模光纤**
>
> - 若光纤的直径减小到只有一个光的波长，则光纤就像一根波导那样，它可使光线一直向前传播，而不会产生多次反射。这样的光纤称为**单模光纤**。

**电力线**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-2c23cb1d18aa345c.png)

### 非导引型传输媒体

非导引型传输媒体是指自由空间。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8432039f51003722.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d2a8692970355b05.png)

**无线电波**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-357bc29ed7591006.png)

**微波**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f042b478ef808a1a.png)

**红外线**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-95eac658ca822ab2.png)

**可见光**

[LIFI](https://baike.baidu.com/item/可见光无线通信/16268518?fromtitle=LiFi&fromid=5675729&fr=aladdin)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-e1bc3e93ff50114b.png)

------

## 传输方式

### 串行传输和并行传输

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-54b03a1b4fd3cdd8.png)

> **串行传输**：
>
> - 数据是一个比特一个比特依次发送的，因此在发送端与接收端之间，只需要一条数据传输线路即可
>
> **并行传输**：
>
> - 一次发送n个比特，因此，在发送端和接收端之间需要有n条传输线路
> - 并行传输的优点是比串行传输的速度n倍，但成本高
>
> 数据在传输线路上的传输采用是**串行传输**，计算机内部的数据传输常用**并行传输**

### 同步传输和异步传输

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-15060e3d8de110ba.png)

> **同步传输**：
>
> - 数据块以稳定的比特流的形式传输。字节之间没有间隔
> - 接收端在每个比特信号的中间时刻进行检测，以判别接收到的是比特0还是比特1
> - 由于不同设备的时钟频率存在一定差异，不可能做到完全相同，在传输大量数据的过程中，所产生的判别时刻的累计误差，会导致接收端对比特信号的判别错位
>
> 所以要使收发双方时钟保持同步

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-19cfd094ecef0538.png)

> **异步传输**：
>
> - 以字节为独立的传输单位，字节之间的时间间隔不是固定
> - 接收端仅在每个字节的起始处对字节内的比特实现同步
> - 通常在每个字节前后分别加上起始位和结束位

### 单向通信（单工）、双向交替通信（半双工）和双向同时通信（全双工）

在许多情况下，我们要使用“**信道（channel）**”这一名词。信道和电路并不等同。信道一般都是用来表示向某一个方向传送信息的媒体。因此，一条通信电路往往包含一条发送信道和一条接收信道。

从通信的双方信息交互的方式来看，可以有以下三种基本方式：

**单向通信**：

又称为**单工通信**，即只能有一个方向的通信而没有反方向的交互。无线电广播或有线电以及电视广播就属于这种类型

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5b07729ff4cd3411.png)

**双向交替通信**：

又称为**半双工通信**，即通信的双方可以发送信息，但不能双方同时发送（当然也就不能同时接收）。这种通信方式使一方发送另一方接收，过一段时间后可以再反过来

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-e0f90a502a95d1b4.png)

**双向同时通信**：

又称为**全双工通信**，即通信的双发可以同时发送和接收信息。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-68977b7eeac3b7f2.png)

> **单向通信**只需要一条信道，而**双向交替通信**或**双向同时通信**则需要两条信道（每个方向各一条）
>
> **双向同时通信**的传输效率最高

## 编码与调制

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-acc59055804f0890.png)

> **常用术语**
>
> - **数据 (data)** —— 运送消息的实体。
> - **信号 (signal)** —— 数据的电气的或电磁的表现。
> - **模拟信号 (analogous signal)** —— 代表消息的参数的取值是连续的。
> - **数字信号 (digital signal)** —— 代表消息的参数的取值是离散的。
> - **码元 (code)** —— 在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。
> - **基带信号**（即基本频带信号）—— 来自信源的信号。像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。
> - 基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。因此必须对基带信号进行**调制** (modulation)。

在计算机网络中，常见的是将数字基带信号通过编码或调制的方法在相应信道进行传输

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ded8a3e566f7687b.png)

### **传输媒体与信道的关系**

> **信道的几个基本概念**
>
> - **信道** —— 一般用来表示向某一个方向传送信息的媒体。
> - **单向通信（单工通信）**——只能有一个方向的通信而没有反方向的交互。
> - **双向交替通信（半双工通信）**——通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)。
> - **双向同时通信（全双工通信）**——通信的双方可以同时发送和接收信息。

严格来说，传输媒体不能和信道划等号

对于单工传输，传输媒体只包含一个信道，要么是发送信道，要么是接收信道

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-414f829a7df390e6.png)

对于半双工和全双工，传输媒体中要包含两个信道，一个发送信道，另一个是接收信道

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d3b3583526407c45.png)

> 如果使用信道复用技术，一条传输媒体还可以包含多个信道

### 常用编码（※）

**不归零编码（Not Return Zero,NRZ）**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-2f6b70fef84339ec.png)

> - 正电平表示比特1/0
> - 负电平表示比特0/1
>
> 中间的虚线是零电平，所谓不归零编码，就是指在整个码元时间内，电平不会出现零电平
>
> **实际比特1和比特0的表示要看现实怎么规定**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0732d0edc74846b5.png)

> 这需要发送方的发送与接收方的接收做到严格的同步
>
> - 需要**额外一根传输线来传输时钟信号**，使发送方和接收方同步，接收方按时钟信号的节拍来逐个接收码元
> - **但是**对于计算机网络，**宁愿利用这根传输线传输数据信号**，而不是传输时钟信号
>
> 由于**不归零编码**存在**同步问题**，因此计算机网络中的数据传输不采用这类编码！

**归零编码(Return Zero,RZ）**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8aa838a116fdafb4.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-2fa351ff35477f1a.png)

> **归零编码**虽然**自同步**，但**编码效率低**

**曼彻斯特编码**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a34a686a9d052e9c.png)

> 在每个码元时间的中间时刻，信号都会发生跳变
>
> - 负跳变表示比特1/0
> - 正跳变表示比特0/1
> - 码元中间时刻的跳变即表示时钟，又表示数据
>
> **实际比特1和比特0的表示要看现实怎么规定**
>
> **传统以太网**使用的就是曼切斯特编码

**差分曼彻斯特编码**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-9a758474e374329a.png)

> 在每个码元时间的中间时刻，信号都会发送跳变，但与**曼彻斯特不同**
>
> - **跳变仅表示时钟**
> - 码元开始处电平是否变换表示数据
>   - 变化表示比特1/0
>   - 不变化表示比特0/1
>
> **实际比特1和比特0的表示要看现实怎么规定**
>
> 比曼彻斯特编码变化少，更适合较高的传输速率

**总结**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-de92dd43d328b4f7.png)

### 调制（※）

数字信号转换为模拟信号，在模拟信道中传输，例如WiFi，采用补码键控CCK/直接序列扩频DSSS/正交频分复用OFDM等**调制**方式。

模拟信号转换为另一种模拟信号，在模拟信道中传输，例如，语音数据加载到模拟的载波信号中传输。频分复用FDM技术，充分利用带宽资源。

**基本调制方法**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-7ce461637de91b6e.png)

> - **调幅AM**：所调制的信号由两种不同振幅的基本波形构成。每个基本波形只能表示1比特信息量。
> - **调频FM**：所调制的信号由两种不同频率的基本波形构成。每个基本波形只能表示1比特信息量。
> - **调相PM**：所调制的信号由两种不同初相位的基本波形构成。每个基本波形只能表示1比特信息量。
>
> 但是使用基本调制方法，1个码元只能包含1个比特信息

**混合调制**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8fec8ccb7ff3ea77.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-30e70220d4127135.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1cb6de826ba63b70.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-600f7802e1eaa18a.png)

> 上图码元所对应的4个比特是错误的，码元不能随便对应4个比特

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1e2617434d904ce4.png)

### 码元（※）

在使用时间域的波形表示数字信号时，代表不同离散数值的基本波形。

## 信道的极限容量

### 造成信号失真的因素

- 任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰。
- 码元传输的速率越高，或信号传输的距离越远，或传输媒体质量越差，在信道的输出端的波形的失真就越严重。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0a9bbf5bcd5e8226.png)

失真的原因：

- 码元传输的速率越高
- 信号传输的距离越远
- 噪声干扰越大
- 传输媒体质量越差

### 奈氏准则（※）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b90918937a54faa6.png)

### 香农公式（※）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-57e105e5df793b93.png)

奈氏准则和香农公式对比：

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5ce50e745950c8eb.png)

## 信道复用技术

### 频分复用、时分复用和统计时分复用

**复用 (multiplexing)** 是通信技术中的基本概念。

它允许用户使用一个共享信道进行通信，降低成本，提高利用率。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8503f147c44d220f.png)

**频分复用 FDM (Frequency Division Multiplexing)**

- 将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。
- **频分复用**的所有用户在同样的时间**占用不同的带宽资源**（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-bcb9321a6a8a3d7a.png)

**时分复用TDM (Time Division Multiplexing)**

- **时分复用**则是将时间划分为一段段等长的**时分复用帧（TDM帧）**。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。
- 每一个用户所占用的时隙是**周期性地出现**（其周期就是TDM帧的长度）的。
- TDM 信号也称为**等时** (isochronous) 信号。
- **时分复用的所有用户在不同的时间占用同样的频带宽度。**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-cb9a20b7ce00d497.png)

- 时分复用可能会造成线路资源的浪费
  - 使用时分复用系统传送计算机数据时，由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-c1ef02caf1f2cfda.png)

**统计时分复用 STDM (Statistic TDM)**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-7f0b54d1c14702ca.png)

### 波分复用

波分复用 WDM(Wavelength Division Multiplexing)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-039cdf67599ebe3b.png)

### 码分复用

码分复用 CDM (Code Division Multiplexing)

- 常用的名词是**码分多址** CDMA (Code Division Multiple Access)。
- 各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。
- 这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。

## 习题

![image-20220806120107256](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806120107256.png)

------

**奈氏准则**

![image-20220806120131758](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806120131758.png)



![image-20220806120152259](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806120152259.png)



![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806125716977.png)

------

**香农公式**

![image-20220806120210472](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806120210472.png)

------

![image-20220806120228491](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806120228491.png)

------

# 数据链路层

## 数据链路层概述

### 概述

**链路**是从一个结点到相邻结点的一段物理线路，**数据链路**则是在链路的基础上增加了一些必要的硬件（如网络适配器）和软件（如协议的实现）

**网络中的主机、路由器等都必须实现数据链路层**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-72eec9c2f5da1885.png)

**局域网中的主机、交换机等都必须实现数据链路层**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4f088da1859e7e90.png)

**从层次上来看数据的流动**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-11c77ea98c206763.png)

**仅从数据链路层观察帧的流动**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6a1acd1ad2a6c1eb.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1dacf9fe20464222.png)

> 主机H1 到主机H2 所经过的网络可以是多种不同类型的
>
> **注意：不同的链路层可能采用不同的数据链路层协议**

**数据链路层使用的信道**

数据链路层属于计算机网路的低层。**数据链路层使用的信道主要有以下两种类型：**

- 点对点信道
- 广播信道

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0f0962eb5fccf66f.png)

> **局域网属于数据链路层**
>
> 局域网虽然是个网络。但我们并不把局域网放在网络层中讨论。这是因为在网络层要讨论的是多个网络互连的问题，是讨论分组怎么从一个网络，通过路由器，转发到另一个网络。
>
> 而在同一个局域网中，分组怎么从一台主机传送到另一台主机，但并不经过路由器转发。从整个互联网来看，**局域网仍属于数据链路层**的范围

### 三个重要问题

数据链路层传送的协议数据单元是**帧**

**封装成帧**

- **封装成帧** (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。
- 首部和尾部的一个重要作用就是进行**帧定界**。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1ad51faea9b7b205.png)

**差错控制**

在传输过程中可能会产生**比特差错**：1 可能会变成 0， 而 0 也可能变成 1。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-82811736b014aa98.png)

**可靠传输**

接收方主机收到有误码的帧后，是不会接受该帧的，会将它丢弃

如果数据链路层向其上层提供的是不可靠服务，那么丢弃就丢弃了，不会再有更多措施

**如果数据链路层向其上层提供的是可靠服务，那就还需要其他措施，来确保接收方主机还可以重新收到被丢弃的这个帧的正确副本**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0d2fd9bb2602bf28.png)

> 以上三个问题都是使用**点对点信道的数据链路层**来举例的

**如果使用广播信道的数据链路层除了包含上面三个问题外，还有一些问题要解决**

如图所示，主机A，B，C，D，E通过一根总线进行互连，主机A要给主机C发送数据，代表帧的信号会通过总线传输到总线上的其他各主机，那么主机B，D，E如何知道所收到的帧不是发送给她们的，主机C如何知道发送的帧是发送给自己的

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-34c5f707bef17f14.png)

可以用编址（地址）的来解决

将帧的目的地址添加在帧中一起传输

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-abbf8309faf2ebf1.png)

还有数据碰撞问题

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-92422213075fe0e3.png)

> 随着技术的发展，交换技术的成熟，
>
> 在 有线（局域网）领域 使用**点对点链路**和**链路层交换机**的**交换式局域网**取代了~~共享式局域网~~
>
> 在无线局域网中仍然使用的是共享信道技术

------

## 封装成帧

### 介绍

封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧

- **帧头和帧尾中包含有重要的控制信息**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-bf6fe42eeea3f376.png)

发送方的数据链路层将上层交付下来的协议数据单元封装成帧后，还要通过物理层，将构成帧的各比特，转换成电信号交给传输媒体，那么接收方的数据链路层如何从物理层交付的比特流中提取出一个个的帧？

答：需要帧头和帧尾来做**帧定界**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-3a36c2a60343962c.png)

但比不是每一种数据链路层协议的帧都包含有帧定界标志，例如下面例子

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f1441c531b4d740e.png)

> 前导码
>
> - 前同步码：作用是使接收方的时钟同步
> - 帧开始定界符：表明其后面紧跟着的就是MAC帧

另外以太网还规定了帧间间隔为96比特时间，因此，MAC帧不需要帧结束定界符

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-eee524ce4e17f0e8.png)

### 透明传输

> **透明**
>
> 指某一个实际存在的事物看起来却好像不存在一样。

透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，好像数据链路层不存在一样

帧界定标志也就是个特定数据值，如果在上层交付的协议数据单元中， 恰好也包含这个特定数值，接收方就不能正确接收

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-12fe81306aedad15.png)

> 所以数据链路层应该对上层交付的数据有限制，其内容不能包含帧定界符的值

**解决透明传输问题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-645dde5eed8eceb2.png)

- **解决方法**：面向字节的物理链路使用**字节填充** (byte stuffing) 或**字符填充** (character stuffing)，面向比特的物理链路使用比特填充的方法实现透明传输
- 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面**插入一个转义字符“ESC”**(其十六进制编码是1B)。
- 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
- 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。

**帧的数据部分长度**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-9d3f61fdd96b7dee.png)

### 总结

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6d39c2f162ddcae5.png)

------

![image-20220806141243177](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806141243177.png)

## 差错检测

### 介绍

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-fa8e42040c9adf41.png)

### 奇偶校验

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8a049d137b19e372.png)

### 循环冗余校验CRC(Cyclic Redundancy Check)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-190a469aba121c1f.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-e3a6540cad78b41e.png)

**例题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-52140f44375b471a.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-01ea200a849a5e31.png)

**总结**

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5b743916f5355e14.png)

> 循环冗余校验 CRC 是一种检错方法，而帧校验序列 FCS 是添加在数据后面的冗余码

------

## 可靠传输

### 基本概念

**下面是比特差错**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-570f7783660d9c10.png)

**其他传输差错**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1a955429af0480a5.png)

- 分组丢失

路由器输入队列快满了，主动丢弃收到的分组

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f805603357f3a3a3.png)

- 分组失序

数据并未按照发送顺序依次到达接收端

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6fdae389d4679bf3.png)

- 分组重复

由于某些原因，有些分组在网络中滞留了，没有及时到达接收端，这可能会造成发送端对该分组的重发，重发的分组到达接收端，但一段时间后，滞留在网络的分组也到达了接收端，这就造成**分组重复**的传输差错

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-88599fefa01ee548.png)

### 三种可靠协议

- 停止-等待协议SW
- 回退N帧协议GBN
- 选择重传协议SR

> 这三种可靠传输实现机制的基本原理并不仅限于数据链路层，可以应用到计算机网络体系结构的各层协议中

### 停止-等待协议

#### 停止-等待协议可能遇到的四个问题

**确认与否认**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-68772b26b0ef0d3a.png)

**超时重传**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-af381efb26eee719.png)

**确认丢失**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-e30648ec8764ab02.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-34bf2b8a370feab8.png)

> 既然数据分组需要编号，确认分组是否需要编号？
>
> 要。如下图所示

**确认迟到**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-da5036b780359576.png)

> 注意，图中最下面那个数据分组与之前序号为0的那个数据分组不是同一个数据分组

**注意事项**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8dbdfdbac8087fd2.png)

#### 停止-等待协议的信道利用率

假设收发双方之间是一条直通的信道

- **TD**：是发送方发送数据分组所耗费的发送时延
- **RTT**：是收发双方之间的往返时间
- **TA**：是接收方发送确认分组所耗费的发送时延

TA一般都远小于TD，可以忽略，当RTT远大于TD时，信道利用率会非常低

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-3b4b0d81e5dd78eb.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4015447553ed26b5.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-372ef347c338b585.png)

> 像停止-等待协议这样通过确认和重传机制实现的可靠传输协议，常称为自动请求重传协议ARQ(**A**utomatic **R**epeat re**Q**uest)，意思是重传的请求是自动进行，因为不需要接收方显式地请求，发送方重传某个发送的分组

### 回退N帧协议GBN

#### 为什么用回退N帧协议

在相同的时间内，使用停止-等待协议的发送方只能发送一个数据分组，而采用流水线传输的发送方，可以发送多个数据分组

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-cc9d42f63bd259cc.png)

回退N帧协议在流水线传输的基础上，利用发送窗口来限制发送方可连续发送数据分组的个数

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-2a7141766ab1aa80.png)

#### 无差错情况流程

发送方将序号落在发送窗口内的0~4号数据分组，依次连续发送出去

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-eee45713110af40a.png)

他们经过互联网传输正确到达接收方，就是没有乱序和误码，接收方按序接收它们，每接收一个，接收窗口就向前滑动一个位置，并给发送方发送针对所接收分组的确认分组，在通过互联网的传输正确到达了发送方

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-13f6dabf165db4e5.png)

发送方每接收一个、发送窗口就向前滑动一个位置，这样就有新的序号落入发送窗口，发送方可以将收到确认的数据分组从缓存中删除了，而接收方可以择机将已接收的数据分组交付上层处理

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0dfe16aee5eb8d75.png)

#### **累计确认**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1414be9bd8307609.png)

> 累计确认
>
> 优点:
>
> - 即使确认分组丢失，发送方也可能不必重传
> - 减小接收方的开销
> - 减小对网络资源的占用
>
> 缺点：
>
> - 不能向发送方及时反映出接收方已经正确接收的数据分组信息

#### **有差错情况**

例如

在传输数据分组时，5号数据分组出现误码，接收方通过数据分组中的检错码发现了错误

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-7a8c7e3ec6ebaca6.png)

于是丢弃该分组，而后续到达的这剩下四个分组与接收窗口的序号不匹配

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-7621ee1bc4ab1619.png)

接收同样也不能接收它们，讲它们丢弃，并对之前按序接收的最后一个数据分组进行确认，发送ACK4，**每丢弃一个数据分组，就发送一个ACK4**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-c3f86dad2611e347.png)

当收到重复的ACK4时，就知道之前所发送的数据分组出现了差错，于是可以不等超时计时器超时就立刻开始重传，具体收到几个重复确认就立刻重传，根据具体实现决定

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-215e8704b22ef7f2.png)

如果收到这4个重复的确认并不会触发发送立刻重传，一段时间后。超时计时器超时，也会将发送窗口内以发送过的这些数据分组全部重传

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1df324a9b09dffb4.png)

若WT超过取值范围，例如WT=8，会出现什么情况？

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d2789fe0732f13ba.png)

习题

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-23afd873fb1ef8d0.png)

**总结**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0d5f64664d096287.png)

- 回退N帧协议在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，是一种连续ARQ协议
- 在协议的工作过程中发送窗口和接收窗口不断向前滑动，因此这类协议又称为滑动窗口协议
- 由于回退N帧协议的特性，当通信线路质量不好时，其信道利用率并不比停止-等待协议高

### 选择重传协议SR

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-2ab9c838fac0cb24.png)

[具体流程请看视频](https://www.bilibili.com/video/BV1c4411d7jb?p=27)

**习题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dfeaa84ab40845d4.png)

**总结**



![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-bcb835b2adac5b3a.png)![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dab51e8895eb9313.png)



------

## 点对点协议PPP

- 点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路层协议
- PPP协议是因特网工程任务组IEIF在1992年制定的。经过1993年和1994年的修订，现在的PPP协议已成为因特网的正式标准[RFC1661，RFC1662]
- 数据链路层使用的一种协议，它的特点是：简单；只检测差错，而不是纠正差错；不使用序号，也不进行流量控制；可同时支持多种网络层协议

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-fd145efb1acc73fa.png)

- PPPoE 是为宽带上网的主机使用的链路层协议

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-bbc4187b9e27ef4c.png)

### 帧格式

必须规定特殊的字符作为帧定界符

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b384615e861000f3.png)

### 透明传输

必须保证数据传输的透明性

实现透明传输的方法

- 面向字节的异步链路：字节填充法（插入“转义字符”）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d40da4575c590f5c.png)

- 面向比特的同步链路：比特填充法（插入“比特0”）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6290c73d8957ee8d.png)

### 差错检测

能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-96bbde153c114cf8.png)

## 工作状态

- 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
- PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
- 这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机
- 分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
- 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-96bbde153c114cf8.png)

> 可见，PPP 协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容。

------

## 媒体接入控制（介质访问控制）——广播信道

**媒体接入控制（介质访问控制）使用一对多的广播通信方式**

> **Medium Access Control**翻译成媒体接入控制，有些翻译成介质访问控制

**局域网的数据链路层**

- 局域网最主要的

  特点

  是：

  - 网络为一个单位所拥有；
  - 地理范围和站点数目均有限。

- 局域网具有如下

  主要优点

  ：

  - 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
  - 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
  - 提高了系统的可靠性、可用性和残存性。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4acef21a5275fab6.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6a109c1bb8576571.png)

**数据链路层的两个子层**

为了使数据链路层能更好地适应多种局域网标准，IEEE 802 委员会就将局域网的数据链路层拆成**两个子层**：

1. **逻辑链路控制** LLC (Logical Link Control)子层；
2. **媒体接入控制** MAC (Medium Access Control)子层。

与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关。 **不管采用何种协议的局域网，对 LLC 子层来说都是透明的。**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-faea2c7d90c97f4d.png)

### 基本概念

为什么要媒体接入控制（介质访问控制）？

**共享信道带来的问题**

若多个设备在共享信道上同时发送数据，则会造成彼此干扰，导致发送失败。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-e8558245e4dd7086.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-3d6792f6b442b459.png)

> 随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式局域网，但由于无线信道的广播天性，无线局域网仍然使用的是共享媒体技术

### 静态划分信道

**信道复用**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f42ef63e4cf0d34b.png)

**频分复用FDM (Frequency Division Multiplexing)**

- 将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。
- **频分复用**的所有用户在同样的时间**占用不同的带宽资源**（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-7b3574f649543f8e.png)

**时分复用TDM (Time Division Multiplexing)**

- **时分复用**则是将时间划分为一段段等长的**时分复用帧（TDM帧）**。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。
- 每一个用户所占用的时隙是**周期性地出现**（其周期就是TDM帧的长度）的。
- TDM 信号也称为**等时** (isochronous) 信号。
- **时分复用的所有用户在不同的时间占用同样的频带宽度。**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-85128fb198aad76c.png)

**波分复用 WDM(Wavelength Division Multiplexing)**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-9f1dfdd7ce2cb611.png)

> 波分复用就是光的频分复用，使用一根光纤来同时传输多个光载波信号
>
> 光信号传输一段距离后悔衰减，所以要用 掺铒光纤放大器 放大光信号

**码分复用 CDM (Code Division Multiplexing)**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-753efa9c750d4ef1.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-91ed6f416ae8fad6.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-91b959793d2ac0de.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-8d81f17d93395b48.png)

### 动态接入控制

受控接入

**受控接入在局域网中使用得较少，本书不再讨论**

**随机接入**

**重点**

### 随机接入（CSMA/CD协议）

**总线局域网使用协议：CSMA/CD**

#### 基本概念

**最初**的**以太网**是将许多计算机都连接到一根总线上。易于实现广播通信。当初认为这样的连接方法既简单又可靠，因为总线上没有有源器件。

> **以太网（Ethernet）**是一种计算机**局域网技术**。IEEE组织的IEEE 802.3标准制定了**以太网（Ethernet）**的技术标准
>
> 以太网采用无连接的工作方式，对发送的数据帧不进行编号，也不要求对方发回确认。目的站收到有差错帧就把它丢弃，其他什么也不做

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-daba961daee80d20.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-00eb7fba113030d2.png)

#### 多址接入MA

表示许多主机以多点接入的方式连接在一根总线上。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a26a912dcecd040a.png)

#### 载波监听CS

是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-9dc7a68973377382.png)

总线上并没有什么“载波”。因此， **“载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。**

#### 碰撞检测CD

- **“碰撞检测”\**就是计算机\**边发送数据边检测**信道上的信号电压大小。
- 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
- 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
- **所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。**
- 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
- **每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-574d77a51611a634.png)

> 为什么要进行碰撞检测？ 因为信号传播时延对载波监听产生了影响
>
> ![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a03963c28232dfb8.png)
>
> A 需要单程传播时延的 2 倍的时间，才能检测到与 B 的发送产生了冲突

#### CSMA/CD 协议工作流程

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5621a9827bd41bf5.png)

#### CSMA/CD 协议工作——争用期（碰撞窗口）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a77d88a950995527.png)

#### CSMA/CD 协议工作——最小帧长

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-423fe21ffdbacb81.png)

#### CSMA/CD 协议工作——最大帧长

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-fa63a8f164fb9191.png)

#### CSMA/CD 协议工作——截断二进制指数退避算法

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-93f832e4b0a569ae.png)

#### CSMA/CD 协议工作——信道利用率

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dc35877bb4bead1a.png)

#### CSMA/CD 协议工作——帧接收流程

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-cf2d95546ecf2664.png)

#### CSMA/CD 协议的重要特性

- 使用 CSMA/CD 协议的以太网不能进行全双工通信而**只能进行双向交替通信（半双工通信）。**
- 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。
- 这种**发送的不确定性**使整个以太网的平均通信量远小于以太网的最高数据率。

> CSMA/CD协议曾经用于各种总线结构以太网和双绞线以太网的早起版本中。
>
> **现在的以太网基于交换机和全双工连接，不会有碰撞，因此没有必要使用CSMA/CD协议**

#### 习题

![image-20220806155528385](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806155528385.png)

![image-20220806155554443](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806155554443.png)

![image-20220806155617077](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806155617077.png)

![image-20220806155641392](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806155641392.png)

------



### 随机接入（CSMA/CA协议）

**无线局域网使用的协议：CSMA/CA**

#### 为什么无线局域网要使用CSMA/CA协议

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dd01f296832d017a.png)

#### 帧间间隔IFS（InterFrame Space）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6c9fe4ae6927eb02.png)

#### CSMA/CA协议的工作原理

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-c0ce898b417b3228.png)

> **源站为什么在检测到信道空闲后还要再等待一段时间DIFS？**
>
> - 考虑到可能有其他的站有高优先级的帧要发送。若有，就要让高优先级帧先发送
>
> **目的站为什么正确接收数据帧后还要等待一段时间SIFS才能发送ACK帧？**
>
> - SIFS是最短的帧间间隔，用来分隔开属于一次对话的各帧，在这段时间内，一个站点应当能够从发送方式切换到接收方式

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a756ebbd569e600a.png)

> **信道由忙转为空闲且经过DIFS时间后，还要退避一段随机时间才能使用信道？**
>
> 防止多个站点同时发送数据而产生碰撞

**使用退避算法的时机**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f0d70f0b26645fb4.png)

#### CSMA/CA协议的退避算法

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1de197cb6f859f3c.png)

**退避算法的示例**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-12262e66fc986d52.png)

#### CSMA/CA协议的信道预约和虚拟载波监听

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-98353d62c0ef033f.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ac35b15f5f22bf7d.png)

**虚拟载波监听机制能减少隐蔽站带来的碰撞问题的示例**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-c8d7aca5f6faec4a.png)

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806200133927.png)

#### 习题

![image-20220806195813446](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806195813446.png)

![image-20220806195921804](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806195921804.png)

![image-20220806200005413](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220806200005413.png)





------



## MAC地址、IP地址以及ARP协议

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-ede2c92a0c809e6c.png)

### MAC地址

> - 使用点对点信道的数据链路层不需要使用地址
> - 使用广播信道的数据链路层必须使用地址来区分各主机

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b498a111836f82c0.png)

#### 广播信道的数据链路层必须使用地址（MAC）

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-eabec58905a9aad1.png)

> **MAC地址又称为硬件地址或物理地址**。请注意：不要被 “物理” 二字误导认为物理地址属于物理层范畴，物理地址属于数据链路层范畴

#### IEEE 802局域网的MAC地址格式

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5a66994327412b90.png)

> **组织唯一标识符OUI**
>
> - 生产网络设备的厂商，需要向IEEE的注册管理机构申请一个或多个OUI
>
> **网络接口标识符**
>
> - 由获得OUI的厂商自行随意分配
>
> **EUI-48**
>
> - 48是这个MAC地址的位数

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-70ee74506eca1df4.png)

> 对于使用EUI-48空间的应用程序，IEEE的目标寿命为100年（直到2080年），但是鼓励采用EUI-64作为替代

**关于无效的 MAC 帧**

- 数据字段的长度与长度字段的值不一致；
- 帧的长度不是整数个字节；
- 用收到的帧检验序列 FCS 查出有差错；
- 数据字段的长度不在 46 ~ 1500 字节之间。
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间。

> **对于检查出的无效** **MAC** **帧就简单地丢弃。以太网不负责重传丢弃的帧。**

#### IEEE 802局域网的MAC地址发送顺序

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d0cf5b54089e4b40.png)

#### 单播MAC地址举例

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-db7d480bafececad.png)

> 主机B给主机C发送**单播帧**，主机B首先要构建该**单播帧**，**在帧首部中的目的地址字段填入主机C的MAC地址**，源地址字段填入自己的MAC地址，再加上帧首部的其他字段、数据载荷以及帧尾部，就构成了该**单播帧**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a69b9384665e17aa.png)

> 主机B将该**单播帧**发送出去，主机A和C都会收到该**单播帧**
>
> 主机A的网卡发现该**单播帧**的目的MAC地址与自己的MAC地址不匹配，丢弃该帧
>
> 主机C的网卡发现该**单播帧**的目的MAC地址与自己的MAC地址匹配，接受该帧
>
> 并将该帧交给其上层处理

#### 广播MAC地址举例

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-7a825d6f30766d99.png)

> 假设主机B要发送一个**广播帧**，主机B首先要构建该**广播帧**，**在帧首部中的目的地址字段填入广播地址**，也就是十六进制的全F，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该**广播帧**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-04fe098832094ecb.png)

> 主机B讲该**广播帧**发送出去，主机A和C都会收到该**广播帧**，**发现该帧首部中的目的地址字段的内容是广播地址**，就知道该帧是**广播帧**，主机A和主机C都接受该帧，并将该帧交给上层处理

#### 多播MAC地址举例

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-3f3a22fe2fbfa3ee.png)

> 假设主机A要发送**多播帧**给该**多播地址**。将该**多播地址**的左起第一个字节写成8个比特，第一个字节的最低比特位是1，这就表明该地址是**多播地址**。
>
> 快速判断地址是不是**多播地址**，就是上图所示箭头所指的第十六进制数不能整除2（1,3,5,7,9,B,D,F），则该地址是**多播地址**
>
> 假设主机B，C和D支持多播，各用户给自己的主机配置多播组列表**如下所示**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f274d401c24ad4d4.png)

> 主机B属于两个多播组，主机C也属于两个多播组，而主机D不属于任何多播组

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1d6c26260c21ba6a.png)

> 主机A首先要构建该**多播帧**，**在帧首部中的目的地址字段填入该多播地址**，源地址点填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该**多播帧**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-70e6e705d20e5c20.png)

> 主机A将该**多播帧**发送出去，主机B、C、D都会收到该**多播帧**
>
> **主机B和C发现该多播帧的目的MAC地址在自己的多播组列表中**，主机B和C都会接受该帧
>
> 主机D发现该**多播帧**的目的MAC地址不在自己得多播组列表中，则丢弃该**多播帧**

> 给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址

### IP地址

IP地址属于网络层的范畴，不属于数据链路层的范畴

下面内容讲的是IP地址的使用，详细的IP地址内容在网络层中介绍

#### 基本概念

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-597f8c69867e595b.png)

#### 从网络体系结构看IP地址与MAC地址

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-407cbc74e63b0e50.png)

#### 数据包转发过程中IP地址与MAC地址的变化情况

图上各主机和路由器各接口的IP地址和MAC地址用简单的标识符来表示

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-77c204bc8181b3ed.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-f12548de1d3cebe1.png)

> 如何从IP地址找出其对应的MAC地址？
>
> ARP协议

![image-20220807153417122](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220807153417122.png)

### ARP协议

如何从IP地址找出其对应的MAC地址？

ARP（地址解析协议）

#### 流程

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5e1fd5537944a420.png)

ARP高速缓存表

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-13b5ca5d08126cde.png)

> 当主机B要给主机C发送数据包时，会首先在自己的ARP高速缓存表中查找主机C的IP地址所对应的MAC地址，但未找到，因此，主机B需要发送ARP请求报文，来获取主机C的MAC地址

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-9de96c1c37c62e26.png)

> ARP请求报文有具体的格式，上图的只是简单描述
>
> ARP请求报文被封装在MAC帧中发送，目的地址为广播地址
>
> 主机B发送封装有ARP请求报文的广播帧，总线上的其他主机都能收到该广播帧

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-97a253fd9b87b3be.png)

> 收到ARP请求报文的主机A和主机C会把ARP请求报文交给上层的ARP进程
>
> 主机A发现所询问的IP地址不是自己的IP地址，因此不用理会
>
> 主机C的发现所询问的IP地址是自己的IP地址，需要进行相应

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d852b42ef4dbea32.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-87f01b333e4599d7.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a3f00154df65aac0.png)

动态与静态的区别

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a013636443263063.png)

**ARP协议只能在一段链路或一个网络上使用，而不能跨网络使用**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d5847fbcc133c6b8.png)

> ARP协议的使用是逐段链路进行的

#### 总结

![image-20220807154026544](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220807154026544.png)

> ARP表中的IP地址与MAC地址的对应关系记录，是**会定期自动删除的**，**因为IP地址与MAC地址的对应关系不是永久性的**

------

## 集线器与交换机的区别

### 集线器-在物理层扩展以太网

#### 概念

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dc092bbcb4344cf5.png)

> - 传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线。
> - 采用双绞线的以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做**集线器** (hub)。
> - **集线器**是也可以看做多口中继器，每个端口都可以成为一个中继器，中继器是对减弱的信号进行放大和发送的设备
> - **集线器**的以太网在逻辑上仍是个总线网，需要使用CSMA/CD协议来协调各主机争用总线，只能工作在半双工模式，收发帧不能同时进行

#### 集线器HUB在物理层扩展以太网

**使用集线器扩展**：将多个以太网段连成更大的、多级星形结构的以太网

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-0f8d87b7f79e94c8.png)

> - 优点
>   1. 使原来属于不同碰撞域的以太网上的计算机能够进行跨碰撞域的通信。
>   2. 扩大了以太网覆盖的地理范围。
> - 缺点
>   1. 碰撞域增大了，但总的吞吐量并未提高。
>   2. 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。

**碰撞域**

- **碰撞域（collision domain）\**又称为\**冲突域**，是指网络中一个站点发出的帧会与其他站点发出的帧产生碰撞或冲突的那部分网络。
- 碰撞域越大，发生碰撞的概率越高。

### 以太网交换机-在数据链路层扩展以太网

#### 概念

- 扩展以太网更常用的方法是在数据链路层进行。
- 早期使用**网桥**，现在使用**以太网交换机**。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-001d34e299bee061.png)

> **网桥**
>
> - 网桥工作在数据链路层。
> - 它根据 MAC 帧的目的地址对收到的帧进行转发和过滤。
> - 当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC 地址，然后再确定将该帧转发到哪一个接口，或把它丢弃。
>
> **交换机**
>
> - 1990 年问世的交换式集线器 (switching hub) 可明显地提高以太网的性能。
> - 交换式集线器常称为**以太网交换机** (switch) 或**第二层交换机** (L2 switch)，强调这种交换机工作在数据链路层。
> - 以太网交换机实质上就是一个**多接口的网桥**

#### **集线器HUB与交换机SWITCH区别**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a8f68b1ee60923c3.png)

> 使用**集线器**互连而成的共享总线式以太网上的某个主机，要给另一个主机发送单播帧，该单播帧会通过共享总线传输到**总线上的其他各个主机**
>
> 使用交换机互连而成的交换式以太网上的某个主机，要给另一个主机发送单播帧，该单播帧进入交换机后，交换机会将该单播帧转发给目的主机，**而不是网络中的其他各个主机**
>
> **这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-bd7d832dc7f8ffbe.png)

> **以太网交换机的交换方式**
>
> - 存储转发方式
>   - 把整个数据帧**先缓存**后再进行处理。
> - 直通 (cut-through) 方式
>   - 接收数据帧的同时就**立即按数据帧的目的 MAC 地址决定该帧的转发接口**，因而提高了帧的转发速度。
>   - **缺点**是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站。
>
> **这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**

**对比集线器和交换机**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-2e2faba35d2d7852.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4638409baba882e8.png)

> 多台主机同时给另一台主机发送单播帧
>
> 集线器以太网：会产生碰撞，遭遇碰撞的帧会传播到总线上的各主机
>
> 交换机以太网：会将它们缓存起来，然后逐个转发给目的主机，不会产生碰撞
>
> **这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**

**集线器扩展以太网和交换机扩展以太网区别**

**单播**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-34c587f82d3a1286.png)

**广播**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-134f67554e64e22b.png)

**多个单播**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d80949431bd76379.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d5c429a2f92149ff.png)

广播域（broadcast domain）：指这样一部分网络，其中任何一台设备发出的广播通信都能被该部分网络中的所有其他设备所接收。

### 总结

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-25db1be3ca96bc2f.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-df6859d2396549cf.png)

> 工作在数据链路层的以太网交换机，其性能远远超过工作在物理层的集线器，而且价格并不贵，这就使得集线器逐渐被市场淘汰

------

## 以太网交换机自学习和转发帧的流程

### 概念

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5f9db8088bf224f9.png)

### 自学习和转发帧的例子

以下例子假设各主机知道网络中其他各主机的MAC地址（无需进行ARP）

**A -> B**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-1ef3dc4a6841b1ce.png)

> 1. A 先向 B 发送一帧。该帧从接口 1 进入到交换机
> 2. 交换机收到帧后，先查找（图中左边）交换表。没有查到应从哪个接口转发这个帧给 B
> 3. 交换机把这个帧的源地址 A 和接口 1 写入（图中左边）交换表中
> 4. 交换机向除接口 1 以外的所有的接口广播这个帧
> 5. 接口 4到接口 2，先查找（图中右边）交换表。没有查到应从哪个接口转发这个帧给 B
> 6. 交换机把这个帧的源地址 A 和接口 1 写入（图中右边）交换表中
> 7. 除B主机之外与该帧的目的地址不相符，将丢弃该帧
> 8. 主机B发现是给自己的帧，接受该帧

**B -> A**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dbe273924b7c8eea.png)

> 1. B 向 A 发送一帧。该帧从接口 3 进入到交换机
> 2. 交换机收到帧后，先查找（图中左边）交换表。发现（图中左边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口1转发出去。于是就把这个帧传送到接口 1 转发给 A。
> 3. 主机 A 发现目的地址是它，就接受该帧
> 4. 交换机把这个帧的源地址 B 和接口 3 写入（图中左边）交换表中

**E -> A**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-cf46c0c890cfa2a4.png)

> 1. E 向 A发送一帧
> 2. 交换机收到帧后，先查找（图中右边）交换表。发现（图中右边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口2转发出去。于是就把这个帧传送到接口 2 转发给 接口 4。
> 3. 交换机把这个帧的源地址 E 和接口 3 写入（图中右边）交换表中
> 4. 接口 4 到 左边的交换机，先查找（图中左边）交换表。发现（图中左边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口1转发出去。于是就把这个帧传送到接口 1 转发给 A。
> 5. 交换机把这个帧的源地址 E 和接口 4 写入（图中左边）交换表中
> 6. 主机 A 发现目的地址是它，就接受该帧

**G -> A**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-4ee1af4bc8187125.png)

> 主机 A、主机 G、交换机 1的接口 1就共享同一条总线（相当于总线式网络，可以想象成用集线器连接了）
>
> 1. 主机 G 发送给 主机 A 一个帧
> 2. 主机 A 和 交换机接口 1都能接收到
> 3. 主机 A 的网卡收到后，根据帧的目的MAC地址A，就知道是发送给自己的帧，就接受该帧
> 4. 交换机 1收到该帧后，首先进行登记工作
> 5. 然后交换机 1对该帧进行转发，该帧的MAC地址是A，在（图中左边）交换表查找MAC 地址有 A
> 6. MAC 地址为 A的接口号是1，但是该帧正是从接口 1 进入交换机的，交换机不会再从该接口 1 将帧转发出去，因为这是没有必要，于是丢弃该帧

随着网络中各主机都发送了帧后，网络中的各交换机就可以学习到各主机的MAC地址，以及它们与自己各接口的对应关系

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-071ec78303db43c3.png)

> 考虑到可能有时要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目。为此，在交换表中每个项目都设有一定的**有效时间**。**过期的项目就自动被删除**。
>
> **以太网交换机的这种自学习方法使得以太网交换机能够即插即用，不必人工进行配置，因此非常方便。**

### 总结

**交换机自学习和转发帧的步骤归纳**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-b39e4a9145068aca.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-3fc4ca18dcbaef03.png)

------

## 以太网交换机的生成树协议STP

### 如何提高以太网的可靠性

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-04211a392a1b4b1c.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5033bf0f4c26a32b.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a65d811129786ec6.png)

### 生成树协议STP

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-d43f5c0c9ddbaf93.png)

> - IEEE 802.1D 标准制定了一个**生成树协议 STP** (Spanning Tree Protocol)。
> - 其**要点**是：**不改变**网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是**无环路的树状结构**，从而消除了兜圈子现象。

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-36746a91a09f583c.png)

------

## 虚拟局域网VLAN

### 为什么要虚拟局域网VLAN

**广播风暴**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a2a78b40ae5307db.png)

**分割广播域的方法**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-89e9ef3fdfcc530c.png)

> 为了分割广播域，所以虚拟局域网VLAN技术应运而生

### 概念

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-3f98534c040b90f4.png)

> - 利用以太网交换机可以很方便地实现虚拟局域网 VLAN (Virtual LAN)。
> - IEEE 802.1Q 对虚拟局域网 VLAN 的**定义**： **虚拟局域网 VLAN** 是由一些局域网网段构成的**与物理位置无关的逻辑组**，而这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个 VLAN。
> - 同一个VLAN内部可以广播通信，不同VLAN不可以广播通信
> - **虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。**
> - 由于虚拟局域网是用户和网络资源的逻辑组合，因此可按照需要将有关设备和资源非常方便地重新组合，使用户从不同的服务器或数据库中存取所需的资源。

### 虚拟局域网VLAN的实现机制

虚拟局域网VLAN技术是在交换机上实现的，需要交换机能够实现以下功能

- 能够处理带有VLAN标记的帧——IEEE 802.1 Q帧
- 交换机的各端口可以支持不同的端口类型，不同端口类型的端口对帧的处理方式有所不同

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-5d3549cc02f9a3b4.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-6af352f81b800a98.png)

**Access端口**

交换机与用户计算机之间的互连

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-44a2e259c33ecfd3.png)

> 同一个VLAN内部可以广播通信，不同VLAN不可以广播通信

**Truck端口**

交换机之间或交换机与路由器之间的互连

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-a93996aae716c6aa.png)

**小例题**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-dbf84ad8998fae58.png)

**华为交换机私有的Hybrid端口类型**

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-653b80a66c3cc5bb.png)

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-239ec8f47d072a9b.png)

### 总结

![image-20220916170557482](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916170557482.png)

> **虚拟局域网优点**
>
> 虚拟局域网（VLAN）技术具有以下主要优点：
>
> 1. 改善了性能
> 2. 简化了管理
> 3. 降低了成本
> 4. 改善了安全性

# 网络层

## 网络层概述

### 简介

- 网络层的主要任务是**实现网络互连**，进而**实现数据包在各网络之间的传输**

![image-20220916170213818](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916170213818.png)

> 这些异构型网络N1~N7如果只是需要各自内部通信，他们只要实现各自的物理层和数据链路层即可
>
> 但是如果要将这些异构型网络互连起来，形成一个更大的互联网，就需要实现网络层设备路由器
>
> 有时为了简单起见，可以不用画出这些网络，图中N1~N7，而将他们看做是一条链路即可

- 要实现网络层任务，需要解决一下主要问题：

  - 网络层向运输层提供怎样的服务（“可靠传输”还是“不可靠传输”）

  在数据链路层那课讲过的可靠传输，详情可以看那边的笔记：网络层对以下的**分组丢失**、**分组失序**、**分组重复**的传输错误采取措施，使得接收方能正确接受发送方发送的数据，就是**可靠传输**，反之，如果什么措施也不采取，则是**不可靠传输**

  - 网络层寻址问题

  ![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916170343412.png)

  - 路由选择问题

  ![image-20220916170413948](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916170413948.png)

  > 路由器收到数据后，是依据什么来决定将数据包从自己的哪个接口转发出去？
  >
  > **依据数据包的目的地址和路由器中的路由表**
  >
  > ![image-20220916170424564](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916170424564.png)
  >
  > 但在实际当中，路由器是怎样知道这些路由记录？
  >
  > - 由用户或网络管理员进行人工配置，这种方法只适用于规模较小且网络拓扑不改变的小型互联网
  >
  > - **另一种是实现各种路由选择协议，由路由器执行路由选择协议中所规定的路由选择算法，而自动得出路由表中的路有记录，这种方法更适合规模较大且网络拓扑经常改变的大型互联网**

![image-20220916170435866](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916170435866.png)

> 补充 **网络层（网际层）**除了 **IP协议**外，还有之前介绍过的**地址解析协议ARP**，还有**网际控制报文协议ICMP**，**网际组管理协议IGMP**

### 总结

![image-20220916170447062](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916170447062.png)

## 网络层提供的两种服务

- 在计算机网络领域，网络层应该向运输层提供怎样的服务（“**面向连接**”还是“**无连接**”）曾引起了长期的争论。
- 争论焦点的实质就是：**在计算机通信中，可靠交付应当由谁来负责**？是**网络**还是**端系统**？

### 面向连接的虚电路服务

**一种观点：让网络负责可靠交付**

- 这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用**面向连接**的通信方式。
- 通信之前先建立**虚电路** (Virtual Circuit)，以保证双方通信所需的一切网络资源。
- 如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。

![image-20220916171353784](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916171353784.png)

**发送方** 发送给 **接收方** 的所有分组都沿着同一条虚电路传送

> - 虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
>
> - 请注意，电路交换的电话通信是先建立了一条真正的连接。
>
> - 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样

### 无连接的数据报服务

**另一种观点：网络提供数据报服务**

- 互联网的先驱者提出了一种崭新的网络设计思路。
- 网络层向上只提供简单灵活的、**无连接的**、**尽最大努力交付**的**数据报服务**。
- 网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
- **网络层不提供服务质量的承诺**。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。

![image-20220916171414092](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916171414092.png)

**发送方** 发送给 **接收方** 的分组可能沿着不同路径传送

> **尽最大努力交付**
>
> - 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的**主机中的运输层负责可靠交付（包括差错处理、流量控制等）** 。
>
> - **采用这种设计思路的好处是**：网络的造价大大降低，运行方式灵活，能够适应多种应用。
>
> - 互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

### 虚电路服务与数据报服务的对比

![image-20220916171506179](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916171506179.png)

## IPv4

### 概述

![img](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/24878825-90e2d995adf53e57.png)



### 分类编制的IPv4地址

#### 简介

![image-20220916173029585](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916173029585.png)

- 每一类地址都由两个固定长度的字段组成，其中一个字段是**网络号 net-id**，它标志主机（或路由器）所连接到的网络，而另一个字段则是**主机号 host-id**，它标志该主机（或路由器）。
- 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
- 由此可见，**一个 IP 地址在整个互联网范围内是唯一的**。

##### **A类地址**

![image-20220916182317819](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916182317819.png)

##### **B类地址**

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916182254788.png)     

##### **C类地址**

![image-20220916182232362](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916182232362.png)

**练习**

![image-20220916183726572](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916183726572.png)

#### 总结

**IP 地址的指派范围**

![image-20220916183755551](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916183755551.png)

**一般不使用的特殊的 IP 地址**

![image-20220916183808741](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916183808741.png)

**IP 地址的一些重要特点**

(1) **IP 地址是一种分等级的地址结构**。分两个等级的好处是：

- **第一**，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。
- **第二**，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。

(2) **实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口**。

- 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为**多归属主机** (multihomed host)。
- 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此**一个路由器至少应当有两个不同的 IP 地址**。

(3) **用转发器或网桥连接起来的若干个局域网仍为一个网络**，因此这些局域网都具有同样的网络号 net-id。

(4) **所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。**

### 划分子网的IPv4地址

#### 为什么要划分子网

在 ARPANET 的早期，IP 地址的设计确实不够合理：

- IP 地址空间的利用率有时很低。
- 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。
- 两级的 IP 地址不够灵活。

![image-20220916184325315](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916184325315.png)

如果想要将原来的网络划分成三个独立的网路

![image-20220916184418654](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916184418654.png)

所以是否可以从主机号部分借用一部分作为子网号

![image-20220916184441369](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916184441369.png)

> 但是如果未在图中标记子网号部分，那么我们和计算机又如何知道分类地址中主机号有多少比特被用作子网号了呢？
>
> 所以就有了划分子网的工具：**子网掩码**
>
> - 从 1985 年起在 IP 地址中又增加了一个“**子网号字段**”，使两级的 IP 地址变成为**三级的 IP 地址**。
>
> - 这种做法叫做**划分子网** (subnetting) 。
>
> - 划分子网已成为互联网的正式标准协议。

#### 如何划分子网

基本思路

- 划分子网纯属一个**单位内部的事情**。单位对外仍然表现为没有划分子网的网络。
- 从主机号**借用**若干个位作为**子网号** subnet-id，而主机号 host-id 也就相应减少了若干个位。

![img](https:////upload-images.jianshu.io/upload_images/24878825-5006c8be601f1a11.png?imageMogr2/auto-orient/strip|imageView2/2/w/545/format/webp)

- 凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的**目的网络号** net-id，先找到连接在本单位网络上的路由器。
- 然后**此路由器**在收到 IP 数据报后，再按**目的网络号** net-id 和**子网号** subnet-id 找到目的子网。
- 最后就将 IP 数据报直接交付目的主机。

划分为三个子网后对外仍是一个网络

![img](https:////upload-images.jianshu.io/upload_images/24878825-5eaab61ca2770932.png?imageMogr2/auto-orient/strip|imageView2/2/w/773/format/webp)

> - **优点**
>
> ```undefined
> 1.  减少了 IP 地址的浪费
>     
>     
> 2.  使网络的组织更加灵活
>     
>     
> 3.  更便于维护和管理
> ```
>
> - **划分子网纯属一个单位内部的事情，对外部网络透明**，对外仍然表现为没有划分子网的一个网络。

#### 子网掩码（※）

![7](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916184615183.png)

> **(IP 地址) AND (子网掩码) = 网络地址** 重要，下面很多相关知识都会用到

举例

例子1

![ ](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916185204530.png)

例子2

![image-20220916185554277](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916185554277.png)

**默认子网掩码**

![image-20220916190710007](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916190710007.png)

#### 总结

![image-20220916191534118](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220916191534118.png)

> - 子网掩码是一个网络或一个子网的重要属性。
>
> - 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。
>
> - 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。
>
> - 若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。

### 无分类编址的IPv4地址

#### 为什么使用无分类编址

**无分类域间路由选择 CIDR** (Classless Inter-Domain Routing)。

![image-20220917123638677](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917123638677.png)

> **CIDR 最主要的特点**
>
> - CIDR使用各种长度的“**网络前缀**”(network-prefix)来代替分类地址中的网络号和子网号。
>
> - **IP 地址从三级编址（使用子网掩码）又回到了两级编址**。

#### 如何使用无分类编址（※）

![image-20220917124712185](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917124712185.png)

举例

![image-20220917124737907](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917124737907.png)

#### 路由聚合（构造超网）（※）

![image-20220917125124041](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917125124041.png)

#### 总结

![image-20220917125932642](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917125932642.png)

### IPv4地址的应用规划

给定一个IPv4地址快，如何将其划分成几个更小的地址块，并将这些地址块分配给互联网中不同网络，进而可以给各网络中的主机和路由器接口分配IPv4地址

#### 定长的子网掩码FLSM（Fixed Length Subnet Mask）

![image-20220917134146264](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917134146264.png)

**划分子网的IPv4就是定长的子网掩码**

举例

![image-20220917133358499](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917133358499.png)

![image-20220917133331024](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917133331024.png)

![image-20220917133259448](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917133259448.png)

> 通过上面步骤分析，就可以从子网1 ~ 8中任选5个分配给左图中的N1 ~ N5
>
> **采用定长的子网掩码划分，只能划分出2^n个子网，其中n是从主机号部分借用的用来作为子网号的比特数量，每个子网所分配的IP地址数量相同**
>
> **但是也因为每个子网所分配的IP地址数量相同，不够灵活，容易造成IP地址的浪费**

#### 变长的子网掩码VLSM（Variable Length Subnet Mask）

![image-20220917134156466](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917134156466.png)

**无分类编址的IPv4就是变长的子网掩码**

举例

![image-20220917134127122](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917134127122.png)

![image-20220917134058806](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917134058806.png)

------

## IP数据报的发送和转发过程

![image-20220917151301160](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917151301160.png)

举例

![image-20220917152602040](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152602040.png)

![image-20220917152628309](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152628309.png)

源主机如何知道目的主机是否与自己在同一个网络中，是直接交付，还是间接交付？

![image-20220917152704069](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152704069.png)

> 可以通过**目的地址IP**和**源地址的子网掩码**进行**逻辑与运算**得到**目的网络地址**
>
> - 如果**目的网络地址**和**源网络地址**  **相同**，就是**在同一个网络**中，属于**直接交付**
>
> - 如果**目的网络地址**和**源网络地址**  **不相同**，就**不在同一个网络**中，属于**间接交付**，传输给主机所在网络的**默认网关**（路由器——下图会讲解）,由默认网关帮忙转发

主机C如何知道路由器R的存在？

![image-20220917152729653](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152729653.png)

> 用户为了让本网络中的主机能和其他网络中的主机进行通信，就必须给其指定本网络的一个路由器的接口，由该路由器帮忙进行转发，所指定的路由器，也被称为**默认网关**
>
> 例如。路由器的接口0的IP地址192.168.0.128做为左边网络的默认网关

![image-20220917152938781](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152938781.png)

> 主机A会将该IP数据报传输给自己的默认网关，也就是图中所示的路由器接口0

路由器收到IP数据报后如何转发？

- 检查IP数据报首部是否出错：
  - 若出错，则直接丢弃该IP数据报并通告源主机
  - 若没有出错，则进行转发
- 根据IP数据报的目的地址在路由表中查找匹配的条目：
  - 若找到匹配的条目，则转发给条目中指示的吓一跳
  - 若找不到，则丢弃该数据报并通告源主机

假设IP数据报首部没有出错，路由器取出IP数据报首部各地址字段的值

![image-20220917152948413](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152948413.png)

接下来路由器对该IP数据报进行查表转发

![image-20220917152829766](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152829766.png)

> 逐条检查路由条目，将目的地址与路由条目中的地址掩码进行逻辑与运算得到目的网络地址，然后与路由条目中的目的网络进行比较，如果相同，则这条路由条目就是匹配的路由条目，按照它的下一条指示，图中所示的也就是接口1转发该IP数据报

![image-20220917152959969](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917152959969.png)

路由器是隔离广播域的

![image-20220917153012891](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917153012891.png)

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917153030026.png)

------



## 静态路由配置及其可能产生的路由环路问题

### 概念

![img](https:////upload-images.jianshu.io/upload_images/24878825-cf80167248b787a0.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

image-20201018155702081

### 多种情况举例

#### **静态路由配置**

举例

![image-20220917170554309](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170554309.png)

#### **默认路由**

举例

默认路由可以被所有网络匹配，但路由匹配有优先级，默认路由是优先级最低的

![image-20220917161409941](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917161409941.png)

#### **特定主机路由**

举例

有时候，我们可以给路由器添加针对某个主机的特定主机路由条目

一般用于网络管理人员对网络的管理和测试

![image-20220917161343218](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917161343218.png)

> 多条路由可选，匹配路由最具体的

#### **静态路由配置错误导致路由环路**

举例

![image-20220917170253202](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170253202.png)

假设将R2的路由表中第三条目录配置错了下一跳

这导致R2和R3之间产生了路由环路

![image-20220917170307855](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170307855.png)

#### **聚合了不存在的网络而导致路由环路**

举例

正常情况

![image-20220917170322251](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170322251.png)

![image-20220917170336322](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170336322.png)

##### 错误情况

![image-20220917170347889](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170347889.png)

##### 解决方法

![image-20220917170357642](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170357642.png)

![image-20220917170408522](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170408522.png)

> 黑洞路由的下一跳为null0，这是路由器内部的虚拟接口，IP数据报进入它后就被丢弃

#### **网络故障而导致路由环路**

举例

![image-20220917170420590](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170420590.png)

![image-20220917170432461](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170432461.png)

##### 解决方法

添加故障的网络为黑洞路由

![image-20220917170445802](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170445802.png)

![image-20220917170500323](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170500323.png)

假设。一段时间后故障网络恢复了

R1又自动地得出了其接口0的直连网络的路由条目

针对该网络的黑洞网络会自动失效

![image-20220917170514748](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170514748.png)

如果又故障

则生效该网络的黑洞网络

![image-20220917170525578](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170525578.png)

### 总结

![image-20220917170535323](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220917170535323.png)

## 路由选择协议

### 概述

![image-20220918155442669](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155442669.png)

**因特网所采用的路由选择协议的主要特点**

![image-20220918155453493](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155453493.png)

**因特网采用分层次的路由选择协议**

- **自治系统 AS**：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。

![image-20220918155505423](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155505423.png)

> 自治系统之间的路由选择简称为域间路由选择，自治系统内部的路由选择简称为域内路由选择

![image-20220918155541158](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155541158.png)

> 域间路由选择使用外部网关协议EGP这个类别的路由选择协议
>
> 域内路由选择使用内部网关协议IGP这个类别的路由选择协议
>
> **网关协议**的名称可称为**路由协议**

**常见的路由选择协议**

![image-20220918155614306](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155614306.png)

**路由器的基本结构**

路由器是一种具有多个输入端口，和输出端口的专用计算机，其任务是转发分组

![image-20220918155627541](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155627541.png)

路由器结构可划分为两大部分：

1、**分组转发部分**

由三部分构成

- 交换结构

- 一组输入端口：

  信号从某个输入端口进入路由器

  ![image-20220918155639355](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155639355.png)

  物理层将信号转换成比特流，送交数据链路层处理

  ![image-20220918155649814](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155649814.png)

  数据链路层识别从比特流中识别出帧，去掉帧头和帧尾后，送交网络层处理

  ![image-20220918155708913](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155708913.png)

  如果送交网络层的分组是普通待转发的数据分组

  ![image-20220918155721741](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155721741.png)

  则根据分组首部中的目的地址进行查表转发

  ![image-20220918155737519](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155737519.png)

  若找不到匹配的转发条目，则丢弃该分组，否则，按照匹配条目中所指示的端口进行转发

- 一组输出端口

  网络层更新数据分组首部中某些字段的值，例如将数据分组的生存时间减1，然后送交数据链路层进行封装

  ![image-20220918155816205](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155816205.png)

  数据链路层将数据分组封装成帧，交给物理层处理

  ![image-20220918155825944](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155825944.png)

  物理层将帧看成比特流将其变换成相应的电信号进行发送

> 路由器的各端口还会有输入缓冲区和输出缓冲区
>
> - 输入缓冲区用来暂存新进入路由器但还来不及处理的分组
>
> - 输出缓冲区用来暂存已经处理完毕但还来不及发送的分组
>
> ![image-20220918155900423](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155900423.png)
>
> **路由器的端口一般都具有输入和输出功能**，这些实例分出了输入端口和输出端口是更好演示路由基本工作过程

2、**路由选择部分**

- 路由选择部分的核心构件是路由选择处理机，它的任务是根据所使用的路由选择协议。周期性地与其他路由器 进行路由信息的交互，来更新路由表

  如果送交给输入端口的网络层的分组是路由器之间交换路由信息的路由报文，则把这种分组送交给路由选择处理机

  ![image-20220918155918291](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155918291.png)

  路由选择处理机根据分组的内容来更新自己的**路由表**

  ![image-20220918155932058](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155932058.png)

  路由选择处理机还会周期性地给其他路由器发送自己所知道的路由信息

  ![image-20220918155951733](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220918155951733.png)

### 路由信息协议RIP

![image-20220919133937817](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919133937817.png)

#### **RIP的基本工作过程**

![image-20220919134207958](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919134207958.png)

举例

![image-20220919134355740](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919134355740.png)

#### **RIP的路由条目的更新规则**

举例1

![image-20220919135134366](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919135134366.png)

> 路由器C的表到达各目的网络的下一条都记为问号，可以理解为路由器D并不需要关心路由器C的这些内容
>
> 假设路由器C的RIP更新报文发送周期到了，则路由器C将自己路由表中的相关路由信息封装到RIP更新报文中发送给路由器D

![image-20220919135144793](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919135144793.png)

> 路由器C能到达这些网络，说明路由器C的相邻路由器也能到达，只是比路由器C的距离大1，于是根据距离的对比，路由器D更新自己的路由表

![image-20220919135154586](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919135154586.png)

举例2

![image-20220919135207224](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919135207224.png)

#### **RIP存在“坏消息传播得慢”的问题**

![image-20220919140412680](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919140412680.png)

![image-20220919140427171](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919140427171.png)

![image-20220919140520367](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919140520367.png)

解决方法

![image-20220919140537711](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919140537711.png)

> 但是，这些方法也不能完全解决“坏消息传播得慢”的问题，这是距离向量的本质决定

#### **总结**

![image-20220919140548298](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20220919140548298.png)

> RIP 协议的优缺点
>
> 优点：
>
> 1. 实现简单，开销较小。
>
> 缺点：
>
> 1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
>
> 1. 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
>
> 1. “坏消息传播得慢”，使更新过程的收敛时间过长。

### 开放最短路径优先OSPF

#### **开放最短路径优先 OSPF (Open Shortest Path First)**

**注意**：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

**概念**

![image-20221019133249924](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019133249924.png)

#### **问候（Hello）分组**

![image-20221019133313019](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019133313019.png)

> IP数据报首部中协议号字段的取值应为89，来表明IP数据报的数据载荷为OSPF分组

#### **发送链路状态通告LSA**

![image-20221019133328208](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019133328208.png)

> 洪泛法有点类似于广播，就是从一个接口进来，从其他剩余所有接口出去

**链路状态数据库同步**

![image-20221019133344398](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019133344398.png)

#### **使用SPF算法计算出各自路由器到达其他路由器的最短路径**

![image-20221019133402474](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019133402474.png)

#### **OSPF五种分组类型**

![image-20221019133715675](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019133715675.png)

#### **OSPF的基本工作过程**

![image-20221019150812061](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019150812061.png)

**OSPF在多点接入网络中路由器邻居关系建立**

如果不采用其他机制，将会产生大量的多播分组

![image-20221019150828462](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019150828462.png)

> 若DR出现问题，则由BDR顶替DR

**为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做区域（Area）**

- 在该自治系统内，所有路由器都使用OSPF协议，OSPF将该自治系统再划分成4个更小的区域
- 每个区域都有一个32比特的区域标识符
- 主干区域的区域标识符必须为0，主干区域用于连通其他区域
- 其他区域的区域标识符不能为0且不相同
- 每个区域一般不应包含路由器超过200个
- 划分区域的好处就是，利用洪泛法交换链路状态信息局限于每一个区域而不是自治系统，这样减少整个网络上的通信量

![image-20221019150840373](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019150840373.png)

#### **总结**

![image-20221019150901459](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019150901459.png)

### 边界网关协议BGP

#### 工作原理

BGP（Border Gateway Protocol） 是**不同自治系统的路由器之间**交换路由信息的协议

![image-20221019152350048](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019152350048.png)

![image-20221019152405230](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019152405230.png)

![image-20221019152503285](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019152503285.png)

![image-20221019152613584](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019152613584.png)







![img](https:////upload-images.jianshu.io/upload_images/24878825-b472dd1a51f30666.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

![image-20221019152743311](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019152743311.png)



#### **总结**

![image-20221019152803723](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019152803723.png)

### 直接封装RIP、OSPF和BGP报文的协议

![image-20221019153335780](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019153335780.png)

------

## IPv4数据报的首部格式（※）

### 各字段的作用

- 一个 IP 数据报由**首部**和**数据**两部分组成。
- **首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。**
- 在首部的固定部分的后面是一些可选字段，其长度是可变的。

![image-20221019160740781](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019160740781.png)

图中的每一行都由32个比特（也就是4个字节）构成，每个小格子称为字段或者域，每个字段或某些字段的组合用来表达IP协议的相关功能

#### 版本、首部长度、可选字段、区分服务、总长度

![image-20221019160834333](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019160834333.png)

> **IP数据报的首部长度一定是4字节的整数倍**
>
> 因为首部中的可选字段的长度从1个字节到40个字节不等，那么，当20字节的固定部分加上1到40个字节长度不等的可变部分，**会造成首部长度不是4字节整数倍时，就用取值为全0的填充字段填充相应个字节**，以确保IP数据报的首部长度是4字节的整数倍

![image-20221019161747421](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019161747421.png)

#### 标识、标志、片偏移

![image-20221019161842253](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019161842253.png)







##### **对IPv4数据报进行分片**

![image-20221019161904143](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019161904143.png)

现在假定分片2的IP数据报经过某个网络时还需要进行分片

![image-20221019161919632](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019161919632.png)





#### 生存时间

![image-20221019162007429](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019162012619.png)

#### 协议

![image-20221019162043409](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019162043409.png)

#### 首部检验和

![image-20221019162108416](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019162108416.png)

#### 源、目的IP地址

![image-20221019162133813](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019162133813.png)

### 总结

![image-20221019162154720](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221019162154720.png)

------

## 网际控制报文协议ICMP

### 概念

架构IP网络时需要特别注意两点：

- 确认网络是否正常工作
- 遇到异常时进行问题诊断

**而ICMP就是实现这些问题的协议**

ICMP的主要功能包括：

- 确认IP包是否成功送达目标地址
- 通知在发送过程当中IP包被废弃的具体原因
- 改善网络设置等

**有了这些功能以后，就可以获得网络是否正常，设置是否有误以及设备有何异常等信息，从而便于进行网络上的问题诊断**

![image-20221021200324045](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200324045.png)

**ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议**

ICMP 报文的格式

![image-20221021200343009](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200343009.png)

### ICMP差错报告报文

#### 终点不可达

![image-20221021200355984](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200355984.png)

#### 源点抑制

![image-20221021200434213](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200434213.png)

#### 时间超过

![image-20221021200448433](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200448433.png)

#### 参数问题

![image-20221021200507141](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200507141.png)

#### 改变路由（重定向）

![image-20221021200521738](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200521738.png)

#### 不应发送ICMP差错报告报文情况

![image-20221021200532842](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200532842.png)

### ICMP应用举例

#### 分组网间探测PING（Packet InterNet Groper）

![image-20221021200548728](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200548728.png)

#### 跟踪路由（traceroute）

![image-20221021200614919](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200614919.png)

##### **tracert命令的实现原理**

![image-20221021200636635](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200636635.png)

![image-20221021200649523](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200649523.png)

![image-20221021200700458](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200700458.png)

### 总结

![image-20221021200736113](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021200736113.png)

------

## 4.9、虚拟专用网VPN与网络地址转换NAT

### 虚拟专用网VPN（Virtual Private Network）

- 由于 **IP 地址的紧缺**，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。
- 考虑到**互联网并不很安全**，一个机构内也并不需要把所有的主机接入到外部的互联网。
- 假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在**机构内部使用**的计算机就可以由本机构**自行分配其 IP 地址**。

![image-20221021201846648](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021201846648.png)

![image-20221021201858824](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021201858824.png)

![image-20221021201911318](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021201911318.png)

> 上图是因特网数字分配机构IANA官网查看IPv4地址空间中特殊地址的分配方案
>
> 用粉红色标出来的地址就是无需申请的、可自由分配的专用地址，或称私有地址

![image-20221021201928634](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021201928634.png)

> 私有地址只能用于一个机构的内部通信，而不能用于和因特网上的主机通信
>
> 私有地址只能用作本地地址而不能用作全球地址
>
> 因特网中所有路由器对目的地址是私有地址的IP数据报一律不进行转发
>
> **本地地址与全球地址**
>
> - **本地地址**——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。
>
> - **全球地址**——全球唯一的 IP 地址，必须向互联网的管理机构申请。
>
> - **问题**：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。

所以部门A和部门B至少需要一个 路由器具有合法的全球IP地址，这样各自的专用网才能利用公用的因特网进行通信

![image-20221021201941164](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021201941164.png)

部门A向部门B发送数据流程

![image-20221021201953071](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021201953071.png)

> 两个专用网内的主机间发送的数据报是通过了公用的因特网，但在效果上就好像是在本机构的专用网上传送一样
>
> 数据报在因特网中可能要经过多个网络和路由器，但从逻辑上看，R1和R2之间好像是一条直通的点对点链路
>
> ![image-20221021202012724](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021202012724.png)
>
> 因此也被称为IP隧道技术

![image-20221021202024769](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021202024769.png)

### 网络地址转换NAT（Network Address Translation）

![image-20221021202044670](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021202044670.png)

举例

![image-20221021202057064](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021202057064.png)

> 使用私有地址的主机，如何才能与因特网上使用全球IP地址的主机进行通信？
>
> 这需要在专用网络连接到因特网的路由器上安装NAT软件

![image-20221021202109650](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021202109650.png)

> 专有NAT软件的路由器叫做NAT路由器
>
> 它至少有一个有效的外部全球IP地址
>
> 这样，所有使用私有地址的主机在和外界通信时，都要在NAT路由器上将其私有地址转换为全球IP地址

假设，使用私有地址的主机要给因特网上使用全球IP地址的另一台主机发送IP数据报

![image-20221021205216744](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205216744.png)

因特网上的这台主机给源主机发回数据报

![image-20221021205227205](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205227205.png)

当专用网中的这两台使用私有地址的主机都要给因特网使用全球地址的另一台主机发送数据报时，在NAT路由器的NAT转换表中就会产生两条记录，分别记录两个私有地址与全球地址的对应关系

![image-20221021205238320](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205238320.png)

这种基本转换存在一个问题

![image-20221021205250850](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205250850.png)

解决方法

![image-20221021205302930](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205302930.png)

> 我们现在用的很多家用路由器都是这种NART路由器

内网主机与外网主机的通信，是否能由外网主机首先发起？

否定

![image-20221021205314869](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205314869.png)

![image-20221021205326518](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205326518.png)

### 总结

![image-20221021205337860](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221021205337860.png)











# 5 运输层

## 5.1、概述

- 之前课程所介绍的计算机网络体系架构中的**物理层**、**数据链路层**以及**网络层**他们共同解决了将主机通过异构网络互联起来所面临的问题，**实现了主机到主机的通信**
- 但实际上在计算机网络中进行**通信的真正实体是位于通信两端主机中的进程**
- **如何为运行在不同主机上的用于进程提供直接的通信服务是运输层的任务**，运输层协议又称为**端到端协议**。

![image-20221026181751083](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221026181751083.png)

### 从计算机体系结构看运输层

![image-20221026182357954](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221026182357954.png)

> 逻辑通信：运输层之间的通信好像是沿水平方向传送数据，但事实上这两个运输层之间并没有一条水平方向的物理连接，要传送的数据是沿着图中上下多次的虚线方向传送的

- 运输层向高层用户屏蔽了下面网络核心的细节（如网络拓扑，所采用的路由选择协议等），它使应用进程看见的就**好像是在两个运输层实体之间有一条端到端的逻辑通信信道**。
- 根据应用需求的不同，**因特网的运输层**为应用层提供了两种不同的运输协议，即**面向连接的TCP**和**无连接的UDP**。



## 5.2、端口号、复用和分用

### 端口号

- 运行在计算机上的进程使用**进程标识符PID**来标志。
- 因特网上的计算机并不是使用统一的操作系统，不同的操作系统（Windows、Linux、Mac OS）又使用**不同格式的进程进行标识**
- TCP/IP体系的运输层使用**端口号**来区分应用层的不同应用进程
  - 端口号使用**16bit**表示，取值范围**0~65535**
    - **熟知端口号**：0~1023，IANA把这些端口号指派给了TCP/IP体系中最重要的一些应用协议，例如：FTP使用21/20，HTTP使用80，DNS使用53
    - **登记端口号**：1024~49151，为没有熟知端口号的应用程序使用、使用这类端口号必须在IANA按照规定的手续登记，以防止重复。例如：Microsoft RDP 微软远程桌面使用的端口是3389
    - **短暂端口号**：49152~65535，留给客户进程选择暂时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用
  - **端口号只具有本地意义**，即端口号只是为了**标识本计算机应用层中的各进程**，在因特网中，**不同计算机中的相同端口号是没有联系的**。

### 发送方的复用和接收方的分用

 ![image-20221026191211863](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221026191211863.png)

**TCP/IP体系的应用层常用协议所使用的的运输层熟知端口号**

![image-20221026191535827](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221026191535827.png)



## 5.3、UDP和TCP的对比

![ ](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027114146188.png)

### 数据传输有无连接

- UDP
  - 无连接
- TCP
  - 面向连接

![image-20221027114310661](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027114310661.png)

> 这里的连接指逻辑连接

### 通信方式

- UDP
  - 支持单播、多播、广播
  - 支持一对一，一对多，多对一和多对多交互通信
- TCP
  - 仅支持单播
  - 每一条TCP连接只能有两个端点EP，只能是一对一通信

![image-20221027114605856](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027114605856.png)

### 对应用报文的处理

- UDP
  - UDP是**面向应用报文**的：对应用层交付的报文直接打包
  - UDP对应用进程交下来的进程既不合并也不拆分，而是保留应用报文的边界
- TCP
  - TCP**不保证接收方**应用进程所**收到的数据块**与**发送方**应用进程所**发出的数据块**具有对应大小的关系
  - 但接收方应用进程收到的字节流必须和发送发应用进程发出的字节流完全一样
  - TCP是**面向字节流**的：这正是TCP实现可靠传输、流量控制以及拥塞控制的基础

![image-20221027115354909](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027115354909.png)

### 是否可靠传输

- UDP
  - UDP向上层提供**无连接不可靠传输**服务
  - 不使用流量控制和拥塞控制
- TCP
  - TCP向上层提供**面向连接的可靠传输**服务
  - 使用流量控制和拥塞控制

![image-20221027115619216](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027115619216.png)

### 首部对比

- UDP
  - 首部开销小，仅8字节
- TCP
  - 首部最小20字节，最大60字节

![image-20221027115917638](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027115917638.png)



## 5.4、TCP的流量控制

- 一般来说，我们总是希望数据传输的更快一些
  - 但如果发送方把数据发送得过快，接收方就可能来不及接收，这就会造成数据的丢失
- 所谓流量控制（flow control）就是**让发送方的发送速率不要太快，要让接收方来得及接收**
- 利用**滑动窗口**机制可以很方便地在TCP连接上实现对发送方的流量控制、

### 报文段丢失

![image-20221027130753307](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027130753307.png)

- seq：TCP报文段首部中的序号字段，取值表示TCP报文段数据载荷的第一个字节的序号
- DATA：表示这是TCP数据报文段
- ACK：TCP报文段首部中的标志位
  - 取值1：表示这是一个TCP确认报文段
- ack：TCP报文段首部中的确认号字段
  - 取值201：表示希望收到序号201及其后续数据
- rwnd：TCP报文段首部中的窗口字段
  - 取值300：表示自己的接收窗口大小为300

![image-20221027130951680](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027130951680.png)

- 主机A收到该累计确定后，将发送窗口向前滑动，使已发送并收到确认的这些数据的序号移出发送窗口
- 主机A将发送缓存中已经收到主机B累计确认的字节数据删除

### 发送窗口满

![image-20221027131311830](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027131311830.png)

### 超时重传

- 发送窗口的第一组字节数据的重传计时器超时，主机A将它们重新封装成一个TCP报文段发送出去

![image-20221027131512530](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027131512530.png)

- 

![image-20221027131733546](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027131733546.png)

- TCP规定：即使接收窗口为0，也必须接受零窗口探测报文段、确认报文段以及携带有紧急数据的报文段

![image-20221027132123103](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027132123103.png)



## 5.5、TCP的拥塞控制 

- **拥塞（congestion）**：在某段时间，若**对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏**
  - 网络的**资源**：在计算机网络中的链路容量（即带宽）、交换结点中的缓存和处理机等
- 若**出现拥塞而不进行控制**，整个网络的**吞吐量将随输入负荷的增大而下降**

![image-20221027152324086](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221027152324086.png)

### TCP的四种拥塞控制算法

![image-20221028144555247](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028144555247.png)

- 发送方维护一个叫做**拥塞窗口cwnd**的状态变量，其值取决于网络的拥塞程度，并且动态变化
  - 拥塞窗口**cwnd的维护原则**：只要网络**没有出现拥塞**，**拥塞窗口**就再**增大**一些；但只要网络**出现拥塞，拥塞窗口就减少**一些
  - 判断出现**网络拥塞的依据**：没有按时收到应当到达的确认报文（即**发生超时重传**）
- 发送方将拥塞窗口作为**发送窗口swnd**，即**swnd=cwnd**
- 维护一个慢开始门限**ssthresh**状态变量：
  - 当cwnd <  ssthresh，使用慢开始算法
  - 当cwnd  > ssthresh，停止使用慢开始算法而改用拥塞避免算法
  - 当cwnd  = ssthresh，即可使用慢开始算法，也可使用拥塞避免算法

#### 慢开始和拥塞避免

**传输轮次**：发送方给接收方发送数据报文段后，接收方给发送方发挥相应的确认报文段。一个传输轮次所对应的时间，其实就是往返时间

**拥塞窗口cwnd**：会随网络拥塞程度，以及所使用的拥塞控制算法动态变化

![image-20221028150325946](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028150325946.png)

- "慢开始"是指一开始向网络注入的报文段少，并不是指拥塞窗口cwnd增长速度慢
- "拥塞避免"并非指完全能够避免拥塞，而是值在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞

#### 快重传和快恢复

- 慢开始和拥塞避免算法是1988年提出的TCP拥塞控制算法(TCP Tahoe版本)

- 1990年又增加了两个新的拥塞控制算法(**改进TCP的性能**)，这就是快重传和快恢复（TCP Reno版本)

  - 有时，**个别报文段**会在网络中**丢失**，但实际上网络**并未发生拥塞**
    - 这将导致**发送方**超时重传，并**误认为**网络发生了**拥塞**

    - **发送方把拥塞窗口cwnd又设置为最小值1**，并错误地启动慢开始算法，因而**降低了传输效率**

- 采用快重传算法可以**让发送方尽早知道发生了个别报文段的丢失**

- 所谓快重传，就是使发送方**尽快进行重传**，而**不是等超时重传计时器超时**再重传

  - 要求接收方不要等待自己发送数据时才进行捎带确认，而是要**立即发送确认**

  - 即使收到了失序的报文段也要立即发出对已收到的报文段的**重复确认**

  - 发送方一旦**收到3个连续的重复确认**，就将相应的报文段**立即重传**，而不是等该报文段的超时重传计时器超时再重传

  - 对于个别丢失的报文段，发送方不会出现超时重传，也就不会误认为出现了拥塞（进而降低拥塞窗口cwnd）。使用快重传可以使整个网络的吞吐量提高约20%

    ![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028151624553.png)

- 发送方一旦收到**3个重复确认**，就知道现在只是丢失了个别的报文段。于是不启动慢开始算法，而**执行快恢复算法**

  - **发送方将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半;开始执行拥塞避免算法**
  - 也有的快恢复实现是把快恢复开始时的拥塞窗口cwnd值再增大一些，即等于新的ssthresh + 3
    - 既然发送方收到3个重复的确认，就表明有3个数据报文段已经离开了网络
    - 这3个报文段不再消耗网络资源而是停留在接收方的接收缓存中
    - 可见现在网络中不是堆积了报文段而是减少了3个报文段。因此可以适当把拥塞窗口扩大些

![image-20221028152322322](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028152322322.png)



## 5.6、TCP超时重传时间的选择

<img src="https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028153133602.png" alt="image-20221028153133602" style="zoom: 50%;" />

### 超时重传时间RTO的计算

- **不能直接使用某次测量得到的RTT样本来计算超时重传时间RTO**

- 利用每次测量得到的RTT样本，计算加权平均**往返时间RTTs(**又称为平滑的往返时间)

  - `RTTs1 = RTT1`
  - `新的RTTs = (1 - α)  × 旧的RTTs + α × 新的RTT样本`
  - 在上式中，0 ≤ α < 1 :
    - 若α很接近于0，则新RTT样本对RTTs的影响不大
    - 若α很接近于1，则新RTT样本对RTTs的影响较大
  - 已成为建议标准的RFC6298推荐的α值为1/8，即0.125

- 用这种方法得出的加权平均往返时间RTTs就比测量出的RTT值更加平滑

- 显然，**超时重传时间RTO应略大于加权平均往返时间RTTs**

  ![image-20221028153735487](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028153735487.png)

### 往返时间RTT的测量

![image-20221028154119544](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028154119544.png)

- 针对**出现超时重传时无法测准往返时间RTT**的问题，**Karn**提出了一个**算法**:

- **在计算加权平均往返时间RTTs时，只要报文段重传了，就不采用其往返时间RTT样本**。也就是出现重传时，不重新计算RTTs，进而超时重传时间RTO也不会重新计算

  - 这又引起了新的问题。设想出现这样的情况:
    - 报文段的时延突然增大了很多，并且之后很长一段时间都会保持这种时延
    - 因此在原来得出的重传时间内，不会收到确认报文段。于是就重传报文段
    - 但根据Karn算法，不考虑重传的报文段的往返时间样本。这样，超时重传时间就无法更新。这会导致报文段反复被重传

- 因此，要**对Karn算法进行修正**。方法是:**报文段每重传一次，就把超时重传时间RTO增大一些**。典型的做法是将新RTO的值取为旧RTO值的2倍

  ![image-20221028154701486](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028154701486.png)

## 5.7 、TCP可靠传输的实现

- TCP基于**以字节为单位的滑动窗口**来实现可靠传输

  - 发送方在未收到接收方的确认是，可将发送窗口内还未发送的数据全部发送出去
  - 接收方只接收序号落入发送窗口内的数据

  ![image-20221028155313809](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028155313809.png)

  - 发送窗口的状态

    ![image-20221028155536719](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028155536719.png)

  - 接收窗口

    ![image-20221028160528836](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028160528836.png)

- 虽然发送方的发送窗口是根据接收方的接收窗口设置的，但在同一时刻，**发送方的发送窗口并不总是和接方的接收窗口**一样大。

  - 网络传送窗口值需要经历一定的时间滞后，并且这个时间还是不确定的。
  - 发送方还可能根据网络当时的拥塞情况适当减小自己的发送窗口尺寸。

- 对于**不按序到达的数据应如何处理**，TCP并无明确规定。

  - 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样做对网络资原的利用不利,因为发送方会重复传送较多的数据。
  - TCP通常对不按序到达的数据是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再**按序交付上层的应用进程**。

- TCP要求接收方必须有**累积确认和捎带确认机制**，这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上。

  - **接收方不应过分推迟发送确认**，否则会导致发送方不必要的超时重传，这反而浪费了网络的资源。
    - TCP标准规定，确认推迟的时间不应超过0.5秒。若收到一连串具有最大长度的报文段，则必须每隔一个报文段就发送一个确认[RFC 1122]。
  - 捎带确认实际上并不经常发生，因为大多数应用程序很少同时在两个方向上发送数据。

- **TCP的通信是全双工通信**。通信中的每一方都在发送和接收报文段。因此，每一方都有自己的发送窗口和接收窗口。在谈到这些窗口时，一定要弄清楚是哪一方的窗口。

### 习题

- ![image-20221028161319869](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028161319869.png)
- ![image-20221028161533899](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028161533899.png)

## 5.8、TCP的运输连接管理

- TCP是面向连接的协议，它基于运输连接来传送TCP报文段

- TCP运输连接的建立和释放是每一次面向连接的通信中必不可少的过程

- TCP运输连接有以下三个阶段：

  - 建立TCP连接
  - 数据传送
  - 释放TCP连接

- TCP的运输连接管理就是使运输连接的建立和释放都能正常地进行

  <img src="https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028182235139.png" alt="image-20221028182235139" style="zoom:50%;" /> 

### TCP的连接建立

- TCP的连接建立要解决以下三个问题:
  - 使TCP双方能够确知对方的存在
  - 使TCP双方能够协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等)
  - 使TCP双方能够对运输实体资源(如缓存大小、连接表中的项目等）进行分配

#### 三次握手

**TCP客户**：其中一台主机中的某个主动发起TCP连接建立的应用进程

**TCP服务器**：另一台主机中被动等待TCP连接建立的应用进程

##### 初始关闭

- 最初，两端的TCP进程都处于**关闭**状态

  ![image-20221028183659974](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028183659974.png)

  - 一开始，TCP服务器进程首先创建**传输控制块**，用来存储TCP连接中的一些重要信息

  <img src="https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028183811328.png" alt="image-20221028183811328" style="zoom:50%;" />

- 之后，就准备接受TCP客户进程的连接请求。此时，TCP服务器进程就进入**监听**状态，等待TCP客户进程的连接请求。

  TCP服务器进程是被动等待来自TCP客户进程的连接请求，而不是主动发起，因此称为**被动打开连接**

  <img src="https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028184015137.png" alt="image-20221028184015137" style="zoom:67%;" />

  - TCP客户进程也是首先创建传输控制块

  ![image-20221028184305934](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028184305934.png)



##### TCP客户进程发送TCP连接请求报文段

- 然后，在打算建立TCP连接时，向TCP服务器进程发送**TCP连接请求报文段**，并进入**同步已发送状态**

  - TCP连接请求报文段首部中的同步位SYN被设置为1，表明这是一个**TCP连接请求报文段**
  - 序号字段seq被设置了一个初始值x，作为TCP客户进程所选择的初始序号
  - 注：TCP规定SYN被设置为1的报文段不能携带数据，但要消耗掉一个序号
  - 由于TCP连接建立时由TCP客户主动发起的，因此称为**主动打开连接**

  ![image-20221028184804003](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028184804003.png)

##### TCP服务器进程发送TCP连接请求确认报文段

- TCP服务器进程收到TCP连接请求报文段后，如果同意建立连接，则向TCP客户进程发送**TCP连接请求确认报文段**，并进入**同步已接收状态**

  - 该报文段首部中的同步位SYN和确认位ACK都设置为1，表明这是一个**TCP连接请求确认报文段**
  - 序号字段seq被设置了初始值y，作为TCP服务器进程所选择的初始序号
  - 确认号字段ack的值被设置成了x+1，这是对TCP客户进程所选择的初始序号的确认
  - 注：这个报文段也不能携带数据，因为它是SYN被设置为1的报文段，但同样要消耗掉一个序号

  ![image-20221028185252944](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028185252944.png)

##### TCP客户进程发送普通的TCP确认报文段

- TCP客户进程收到TCP连接请求确认报文段后，还要向TCP服务器进程发送一个**普通的TCP确认报文段**，并进入**连接已建立状态**

  - 该报文首部中的确认位ACK被设置为1，表明这是一个**普通的TCP确认报文段**

  - 序号字段seq被设置为x+1，这是因为TCP客户进程发送的第一个TCP报文段的序号为x，并且**不携带数据**

  - 注：TCP规定普通的TCP报文段可以携带数据，但如果不携带数据，则不消耗序号。在这种情况下，所发送的下一个数据报文段的序号仍是x+1

    ![image-20221028191604752](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028191604752.png)

  - 确认号字段ack被设置为y+1，这是对TCP服务器进程所选择的初始序号的确认，TCP服务器进程收到该确认报文段后也进入连接已建立状态

    ![image-20221028204034112](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028204034112.png)

##### 最终连接

- 现在，TCP双方都进入了连接已建立状态，它们可以基于已建立好的TCP连接进行可靠的数据传输

------



#### **发送针对TCP连接请求的确认的确认是否多余？**

![image-20221028204425171](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221028204425171.png)

- 答：不多余！这是为了防止已失效的连接请求报文段突然有传送到了TCP服务器，因而导致错误



### TCP的连接释放

- TCP通过"**四报文挥手**"来释放连接

#### 四次挥手

##### 初始连接

- 数据传输结束后，TCP双方都可以释放连接。现在**TCP客户进程**和**TCP服务器进程**都处于**连接已建立状态**

  ![image-20221029175801876](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029175801876.png)

##### TCP客户进程发送TCP连接释放报文段

- 假设使用**TCP客户进程**的应用进程通知其主动关闭TCP连接，**TCP客户进程**会发送**TCP连接释放报文段**，并进入**终止等待1状态**。

  - 该报文段首部中的终止位FIN和确认位ACK的值都被设置为1，表明这是一个**TCP连接释放报文段**，同时也对之前收到的报文段进行确认
  - 序号seq字段的值设置为u，它等于**TCP客户进程**之前已传送过的、数据的最后一个字节的序号加1
  - 注：TCP规定终止位FIN等于1的报文段即使不携带数据，也要消耗掉一个序号
  - 确认号ack字段的值设置为v，它等于**TCP客户进程**之前已收到的、数据的最后一个字节的序号加1

  ![image-20221029184235311](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029184235311.png)

##### TCP服务器进程发送普通的TCP确认报文段

- **TCP服务器进程**收到**TCP连接释放报文段**后，会发送一个**普通的TCP确认报文段**并进入**关闭等待状态**

  - 该报文段首部中的确认位ACK的值被设置为1，表明这是一个**普通的TCP确认报文段**
  - 序号seq字段的值设置为v，它等于**TCP服务器进程**之前已传送过的数据的最后一个字节的序号加1，这也与之前收到的**TCP连接释放报文段**中的确认号匹配
  - 确认号ack字段的值设置为u+1，这是对**TCP连接释放报文段**的确认

  ![image-20221029190122706](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029190122706.png)

- **TCP服务器进程**这时应通知高层应用进程：**TCP客户进程**要断开与自己的TCP连接

  - 此时，从**TCP客户进程**到**TCP服务器进程**这个方向的连接就释放了，这时的**TCP连接**属于**半关闭状态**
  - 也就是**TCP客户进程**已经没有数据要发送了，但**TCP服务器进程**如果还有数据要发送，**TCP客户进程**仍要接收
  - 也就是说，从**TCP服务器进程**到**TCP客户进程**这个方向的连接并未关闭

  ![image-20221029190159668](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029190159668.png)

- **TCP客户进程**收到**TCP确认报文段**后就进入**终止等待2状态**，等待TCP服务器进程发出的**TCP连接释放报文段**

  - 若使用**TCP服务器进程**的应用进程已经没有数据要发送了，应用进程就通知其**TCP服务器进程**释放连接
  - 由于TCP连接释放是由**TCP客户进程**主动发起的，因此**TCP服务器进程**对TCP连接的释放称为**被动关闭连接**

  ![image-20221029190444096](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029190444096.png)

##### TCP服务器进程发送TCP连接释放报文段

- **TCP服务器进程**发送**TCP连接释放报文段**并进入**最后确认状态**

  - 该报文段首部中的终止位FIN和确认位ACK的值都被设置为1，表明这是一个**TCP连接释放报文段**，同时也对之前收到的报文段进行确认
  - 现在假定序号seq字段的值为w，这是因为在半关闭状态下，**TCP服务器进程**可能又发送了一些数据
  - 确认号ack字段的值为u+1，这是对之前收到的**TCP连接释放报文段**的重复确认

  ![image-20221029191001036](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029191001036.png)

##### TCP客户进程发送普通的TCP确认报文段

- **TCP客户进程**收到**TCP连接释放报文段**后，必须针对该报文段发送**普通的TCP确认报文段**，之后进入**时间等待状态**

  - 该报文段首部中的确认位ACK的值被设置为1，表明这是一个**普通的TCP确认报文段**
  - 序号seq字段的值设置为u+1，这是因为**TCP客户进程**之前发送的**TCP连接释放报文段**虽然不携带数据，但要消耗掉一个序号
  - 确认号ack字段的值设置为w+1，这是对所收到的**TCP连接释放报文段**的确认

  ![image-20221029191420697](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029191420697.png)

##### 最终关闭

- **TCP服务器进程**收到该报文段后就进入**关闭状态**，而**TCP客户进程**还要经过2MSL后才能进入**关闭状态**

  - **MSL**（Maximum Segment Lifetime）意思是**最长报文段寿命**，RFC793建议为2分钟
  - 也就是说**TCP客户进程**进入时间·等待状态后，还要经过4分钟才能进入**关闭状态**

  ![image-20221029191727566](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029191727566.png)

#### TCP客户进程的时间等待状态是否有必要？

- **时间等待状态**以及处于该状态2MSL时长，可以确保**TCP服务器进程**可以收到最后一个**TCP确认报文段**而进入**关闭状态**

- 另外，**TCP客户进程**再发送完最后一个**TCP确认报文段**后，再经过2MSL时长，就可以使本次连接持续时间内所产生的所有报文段都从网络中消失，这样就可以使下一个新的TCP连接中，不会出现旧连接中的报文段

  ![image-20221029192659299](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029192659299.png)

#### 保活计时器

![image-20221029192858099](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029192858099.png)

## 5.9、TCP报文段的首部格式

- 为了实现可靠传输，TCP采用了**面向字节流**的方式

- 但TCP在发送数据时，是从发送缓存取出部分或全部字节并给其添加一个首部使之成为**TCP报文段**后进行发送。
  - 一个TCP报文段由**首部**和**数据载荷**两部分构成
  - TCP的全部功能都体现在它首部中各字段的作用
  - <img src="https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029193723283.png" alt="image-20221029193723283" style="zoom:50%;" />



![image-20221029201638295](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029201638295.png)

- **源端口**:占16比特，写入源端口号，用来标识发送该TCP报文段的应用进程
- **目的端口**:占16比特，写入目的端口号，用来标识接收该TCP报文段的应用进程

------



- **序号**: 占32比特，取值范围[0，2^31-1]，序号增加到最后一个后，下一个序号就又回到0。
  - **指出本TCP报文段数据载荷的第一个字节的序号**。
  - ![image-20221029194452032](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029194452032.png)

- **确认号**: 占32比特，取值范围[0，2^31-1]，确认号增加到最后一个后，下一个确认号就又回到0。
  - **指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前!收到的所有数据的确认**。
  - 若确认号=n,则表明到序号n-1为止的所有数据都已正确接收，期望接收序号为n的数据
- **确认标志位ACK**: 取值为1时确认号字段才有效;取值为0时确认号字段无效。
  - **TCP规定,在连接建立后所有传送的TCP报文段都必须把ACK置1**

![image-20221029194957040](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029194957040.png)

------



- **数据偏移**: 占4比特，并以4字节为单位。

  - **用来指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远**
  - **这个字段实际上是指出了TCP报文段的首部长度**
    - 首部固定长度为20字节，因此数据偏移字段的最小值为(0101)2
    - 首部最大长度为60字节，因此数据偏移字段的最大值为(1111)2

  ![image-20221029195705076](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029195705076.png)

- **保留**:占6比特，保留为今后使用，但目前应置为0

- **窗口**:占16比特，以字节为单位。指出发送本报文段的一方的接收窗口
  - **窗口值作为接收方让发送方设置其发送窗口的依据**
  - **这是以接收方的接收能力来控制发送方的发送能力，称为流量控制**

- **校验和**:占16比特，检查范围包括TCP报文段的首部和数据载荷两部分。
  - 在计算校验和时，要在TCP报文段的前面加上12字节的伪首部。

- **同步标志位SYN**: 在TCP连接建立时用来同步序号

  ![image-20221029200101754](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029200101754.png)

- **终止标志位FIN**:用来释放TCP连接

  ![image-20221029200224449](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221029200224449.png)

- **复位标志位RST**:用来复位TCP连接
  - **当RST=1时,表明TCP连接出现了异常，必须释放连接，然后再重新建立连接**
  - **RST置1还用来拒绝一个非法的报文段或拒绝打开一个TCP连接**

- **推送标志位PSH**:接收方的TCP收到该标志位为1的报文段会**尽快上交应用进程**而不必等到接收缓存都填满后再向上交付。

- **紧急标志位URG**:取值为1时紧急指针字段有效；取值为0时紧急指针字段无效。
- **紧急指针**:占16比特，以字节为单位，用来指明紧急数据的长度。
  - 当发送方有紧急数据时，可将紧急数据插队到发送缓存的最前面，并立刻封装到一个TCP报文段中进行发送。
  - 紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据。

- **选项**：
  - **最大报文段长度MSS选项**:TCP报文段数据载荷部分的最大长度。窗口扩大选项:为了扩大窗口(提高吞吐率)。
  - **时间戳选项**:
    - 用来计算往返时间RTT
    - 用于处理序号超范围的情况，又称为防止序号绕回PAWS。
  - **选择确认选项**

- **填充**:由于选项的长度可变，因此使用填充来确保报文段首部能被4整除

  (因为数据偏移字段，也就是首部长度字段，是以4字节为单位的)

# 6 应用层

## 6.1、应用层概述

- 应用层是计算机网络体系结构的最顶层，是设计和建立计算机网络的最终目的，也是计算机网络中发展最快的部分。
  - 早期基于文本的应用(电子邮件、远程登录、文件传输、新闻组)20世纪90年代将因特网带入千家万户的万维网www
  - 当今流行的即时通信、P2P文件共享及各种音视频应用
  - 计算设备的小型化和“无处不在”，宽带住宅接入和无线接入的日益普及和迅速发展，为未来更多的新型应用提供了广阔的舞台。
- 在本章中，我们以一些经典的网络应用为例来学习有关网络应用的原理、协议和实现方面的知识。

![image-20221101145005309](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101145005309.png)

我们在浏览器的地址中输入某个网站的域名后，就可以访问该网站的内容，这个就是**万维网WWW应用**，其相关的应用层协议为**超文本传送协议HTTP**

![image-20221101143141129](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101143141129.png)

用户在浏览器地址栏中输入的是“见名知意”的**域名**，而TCP/IP的网际层使用**IP地址**来表示目的主机，从域名到IP地址的装转换，由属于**应用层范畴的域名系统DNS**，在后台帮用户完成

![image-20221101143202544](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101143202544.png)



常见的应用

![image-20221101143227932](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101143227932.png)



总结

![image-20221101143250141](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101143250141.png)



------



## 6.2、客户/服务器方式（C/S方式）和对等方式（P2P方式）

### 客户/服务器方式（C/S方式）

- 客户/服务器(Client/Server，C/S)方式
  - 客户和服务器是指通信中所涉及的两个应用进程。
  - 客户/服务器方式所描述的是进程之间服务和被服务的关系。
  - **客户是服务请求方，服务器是服务提供方。**
  - **服务器总是处于运行状态，并等待客户的服务请求。服务器具有固定端口号（例如HTTP服务器的默认端口号为80)，而运行服务器的主机也具有固定的IP地址**。
- C/S方式是因特网上传统的、同时也是最成熟的方式，很多我们熟悉的网络应用采用的都是C/S方式。包括万维网www、电子邮件、文件传输FTP等。
- 基于C/S方式的应用服务通常是**服务集中型**的，即应用服务集中在网络中比客户计算机少得多的服务器计算机上。
  - 由于一台服务器计算机要为多个客户机提供服务，在C/S应用中，**常会出现服务器计算机跟不上众多客户机请求的情况**。
  - 为此，在C/S应用中，常用**计算机群集**（或服务器场）构建一个强大的**虚拟服务器**。

![image-20221101144415977](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101144415977.png)

### 对等方式（P2P方式）

- **对等(Peer-to-Peer，P2P)方式**
- 在P2P方式中，**没有固定的服务请求者和服务提供者**，分布在网络边缘各端系统中的应用进程是对的，被称为**对等方**。**对等方相互之间直接通信**，每个对等方既是服务的请求者，又是服务的提供者。目前，在因特网上流行的P2P应用主要包括P2P文件共享、即时通信、P2P流媒体、分布式存储等。
- 基于P2P的应用是**服务分散型**的，因为服务不是集中在少数几个服务器计算机中，而是分散在大量对等计算机中，这些计算机并不为服务提供商所有，而是为个人控制的桌面计算机和笔记本电脑，它们通常位于住宅、校园和办公室中。
- P2P方式的最突出特性之一就是它的**可扩展性**。因为系统每增加一个对等方，不仅增加的是服务的请求者，同时也增加了服务的提供者，**系统性能不会因规模的增大而降低**。
- P2P方式**具有成本上的优势**，因为它通常不需要庞大的服务器设施和服务器带宽。为了降低成本，服务提供商对于将P2P方式用于应用的兴趣越来越大。

![image-20221101144239184](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101144239184.png)

### 总结

![image-20221101144616059](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101144616059.png)



------



## 6.3、动态主机配置协议DHCP

### 概念

* 互联网广泛使用的**动态主机配置协议 DHCP** (Dynamic Host Configuration Protocol) 提供了**即插即用连网** (plug-and-play networking) 的机制。
* 这种机制允许一台计算机加入新的网络和获取 IP 地址，而不用手工配置。



### DHCP的作用

在之前，如果要正常访问Web服务器，需要该主机手动配置网络的相关配置信息

![image-20221101145153377](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101145153377.png)

> 如果主机数很多，就工作量大，容易出错

如果我们给网络中添加一台DHCP服务器

![image-20221101145249506](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101145249506.png)



### DHCP的工作过程

**DHCP 使用客户 - 服务器方式**

* 需要 IP 地址的主机在启动时就向 DHCP 服务器广播发送发现报文
  （DHCP DISCOVER），这时该主机就成为 DHCP 客户。
* 本地网络上所有主机都能收到此广播报文，但只有 DHCP 服务器才回答此广播报文。
* DHCP 服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。若找不到，则从服务器的 IP 地址池 (address pool) 中取一个地址分配给该计算机。DHCP服务器的回答报文叫做提供报文（DHCP OFFER）。 

**DHCP 工作方式**

* DHCP 使用客户-服务器方式，采用请求/应答方式工作。
* DHCP 基于 UDP 工作（DHCP报文在运输层会被封装成为UDP用户数据报），DHCP 服务器运行在 67 号端口， DHCP客户运行在 68 号端口。

**DHCP交互过程**

![image-20221101145903327](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101145903327.png)

> **DHCP客户端将广播发送DHCP发现报文（DHCP DISCOVER）**
>
> * 事务ID
> * DHCP客户端的MAC地址
>
> **封装该报文的IP数据报的源IP地址为0.0.0.0，这是因为主机目前还未分配到IP地址**，因此使用该地址代替
>
> **目的IP地址为广播地址255.255.255.255，之所以广播发送，是因为主机现在并不知道网络中有哪几个DHCP服务器**。它们的IP地址各是什么
>
> **DHCP服务器收到DHCP发现报文后，根据其中封装的DHCP客户端的MAC地址来查找自己的数据库**，如果查到匹配信息，则使用这些配置信息来构建并发送DHCP提供报文，如果没有则采用默认配置信息来构建报文并发送

![image-20221101150129196](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101150129196.png)

> **DHCP服务端将广播发送DHCP提供报文（DHCP OFFER）**
>
> * 事务ID：DHCP客户端会与之前DHCP发现报文的事务ID做对比，来判断该DHCP提供报文是否是自己的
> * 配置信息：
>   * IP地址：DHCP服务器从自己的IP地址池中挑选待租用给主机的IP地址（使用ARP来确保所选IP地址未被网络中其他主机占用）
>   * 子网掩码
>   * 地址租期
>   * 默认网关
>   * DNS服务器
>
> 源IP地址：发送DHCP提供报文的DHCP服务器的IP
>
> 目的地址：因为目的主机还没分配到IP，所以使用广播地址

在本例中，DHCP客户会收到两个DHCP服务器发来的DHCP提供报文，DHCP客户从中选择一个，一般选择先到的，并向所选择的DHCP服务器发送DHCP请求报文

![image-20221101150316030](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101150316030.png)

> **DHCP客户端将广播发送DHCP请求报文（DHCP REQUEST）**
>
> * 事务ID
> * DHCP客户端的MAC地址
> * 接收的租约中的IP地址
> * 提供此租约的DHCP服务器端的IP地址
>
> 源地址：0.0.0.0，因为此时DHCP客户才从多个DHCP服务器中挑选一个作为自己的DHCP服务器。它首先要征得该服务器的同意，之后才能正式使用向该DHCP服务器租用的IP地址
>
> 目的地址：广播地址，这样可以一次性向所有DHCP服务器发送DHCP请求报文，来告知它们是否请求它们作为自己的DHCP服务器

在本例中，假设DHCP客户端选择DHCP服务器1作为自己的DHCP服务器，DHCP服务器1接受该请求，于是DHCP服务器1给DHCP客户端发送DHCP确认报文

![image-20221101150425277](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101150425277.png)

> 源地址：DHCP服务器1的IP地址
>
> 目的地址：广播地址
>
> **DHCP客户收到该报文后就可以使用租用的IP地址**
>
> **在使用前还会进行ARP检测**

剩下流程图示

![image-20221101150706114](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101150706114.png)



### DHCP中继代理

下图的网络拓扑中的各主机是否可以通过DHCP来自动获取到网络配置？



![image-20221101150759654](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101150759654.png)

> 使用DHCP中继代理是因为我们不用给每一个网络上都设置一个DHCP服务器，这样会使DHCP服务器的数量太多



### 总结

- 动态主机配置协议DHCP(Dynamic Host Configuration Protocol)提供了一种机制，称为即插即用连网。这种机制**允许一台计算机加入新网络时可自动获取IP地址等网络配置信息而不用手工参与**。
- DHCP主要使用以下报文来实现其功能:
  - DHCP DISCOVER: DHCP发现报文
  - DHCP OFFER: DHCP提供报文
  - DHCP REQUEST: DHCP请求报文
  - DHCP ACK: DHCP确认报文
  - DHCP NACK: DHCP否认报文
  - DHCP RELEASE: DHCP释放报文
- DHCP报文**在运输层使用UDP协议封装**
  - DHCP客户使用的UDP端口号为68
  - DHCP服务器使用的UDP端口号为67
- DHCP客户在**未获取到IP地址时使用地址0.0.0.0**
- 在每一个网络上都设置一个DHCP服务器会使DHCP服务器的数量太多。因此现在是使每一个网络至少有一个**DHCP中继代理（通常是一台路由器)**，它配置了DHCP服务器的IP地址信息，作为各网络中计算机与DHCP服务器的桥梁。



------



## 6.4、域名系统DNS

### 概述

域名相比IP地址更容易记忆

![image-20221101151256246](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101151256246.png)

因特网是否可以只使用一台DNS服务器？不行

- 这种做法并不可取。因为因特网的规模很大，这样的域名服务器肯定会因为超负荷而无法正常工作，而且一旦域名服务器出现故障，整个因特网就会瘫痪。
- 早在1983年,因特网就开始采用**层次结构的命名树**作为主机的名字(即域名)，并使用**分布式的域名系统**DNS。
- DNS使**大多数域名都在本地解析**，仅少量解析需要在因特网上通信，因此系统效率很高。
- 由于DNS是分布式系统，即使单个计算机出了故障，也不会妨碍整个系统的正常运行。

### 域名结构

- 因特网采用**层次树状结构的域名结构**
- 域名的结构由若干个分量组成，各分量之间用“点”隔开，分别代表不同级别的域名。
  - **`….三级域名.二级域名.顶级域名`**
  - 每一级的域名都由英文字母和数字组成，不超过63个字符，不区分大小写字母。
  - 级别最低的域名写在最左边，而级别最高的顶级域名写在最右边。
  - 完整的域名不超过255个字符。
- 域名系统既不规定一个域名需要包含多少个下级域名，也不规定每一级的域名代表什么意思。
- 各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由因特网名称与数字地址分配机构ICANN进行管理

![image-20221101151637001](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101151637001.png)





- **顶级域名TLD (Top Level Domain)**分为以下三类:

  - 国家顶级域名nTLD采用ISO 3166的规定。如cn表示中国，us表示美国，uk表示英国、等等。通用顶级域名gTLD
  - 最常见的通用顶级域名有七个，即: **com(公司企业)**、 net(网络服务机构)、org (非营利性组织)、int(国际组织)、edu(美国教育结构)、gov(美国政府部门) . mil(美国军事部门)。
  - 反向域arpa

- 用于反向域名解析，即IP地址反向解析为域名。

- 在**国家顶级域名下注册的二级域名均由该国家自行确定**。例如，顶级域名为jp的日本，将其教育和企业机构的二级域名定为ac和co，而不用edu和com。

- **我国**则将**二级域名**划分为以下**两类**:

  - 类别域名

    共七个: ac(科研机构)、**com (工、商、金融等企业)**.edu(教育机构).gov(政府部门).net(提供网络服务的机构).mil(军事机构）和org (非营利性组织)。

  - 行政区域名

    共34个，适用于我国的各省、自治区、直辖市。例如:bj为北京市、sh为上海市.js为江苏省，等等。

> 名称相同的域名其等级未必相同

#### 因特网的域名空间

![image-20221101152454040](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101152454040.png)

![image-20201023235910545](E:\学习笔记\计算机网络\计算机网络第6章（应用层）.assets\image-20201023235910545.png)

#### 域名服务器类型

- 域名和IP地址的映射关系必须保存在域名服务器中，供所有其他应用查询。显然不能将所有信息都储存在一台域名服务器中.DNS使用分布在各地的域名服务器来实现域名到IP地址的转换。

- 域名服务器可以划分为以下四种不同的类型:

  - **根域名服务器**

    根域名服务器是最高层次的域名服务器。每个根域名服务器都知道所有的顶级域名服务器的域名及其IP地址。因特网上共有**13个**不同IP地址的根域名服务器。尽管我们将这13个根域名服务器中的每一个都视为单个的服务器，但“每台服务器”实际上是由许多分布在世界各地的计算机构成的**服务器群集**。当本地域名服务器向根域名服务器发出查询请求时，路由器就把查询请求报文转发到离这个DNS客广最近的一个根域名服务器。这就加快了DNS的查询过程，同时也更合理地利用了因特网的资源。**根域名服务器通常并不直接对域名进行解析而是返回该域名所属顶级域名的顶级域名服务器的IP地址**。

  - **顶级域名服务器**

    这些域名服务器负责**管理在该顶级域名服务器注册的所有二级域名**。当收到DNS查询请求时就给出相应的回答（可能是最后的结果，也可能是下一级权限域名服务器的IP地址)。

  - **权限域名服务器**

    这些域名服务器负责**管理某个区的域名**。每一个主机的域名都必须在某个权限域名服务器处注册登记。因此权限域名服务器知道其管辖的域名与IP地址的映射关系。另外，权限域名服务器还知道其下级域名服务器的地址。

  - **本地域名服务器**

    本地域名服务器不属于上述的域名服务器的等级结构。当一个主机发出DNS请求报文时，这个报文就首先被送往该主机的本地域名服务器。**本地域名服务器起着代理的作用，会将该报文转发到上述的域名服务器的等级结构中**。每一个因特网服务提供者lSP，一个大学，甚至一个大学里的学院，都可以拥有一个本地域名服务器，它有时也称为**默认域名服务器**。本地域名服务器离用户较近，一般不超过几个路由器的距离，也有可能就在同一个局域网中。本地域名服务器的IP地址需要直接配置在需要域名解析的主机中。

### 域名解析过程

![image-20221101160624523](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101160624523.png)

- 为了提高DNS的查询效率，并减轻根域名服务器的负荷和减少因特网上的DNS查询报文数量，在域名服务器中广泛地使用了**高速缓存**。高速缓存用来存放最近查询过的域名以及从何处获得域名映射信息的记录。
- 由于域名到IP地址的映射关系并不是永久不变，为保持高速缓存中的内容正确，域名服务器**应为每项内容设置计时器并删除超过合理时间的项**（例如，每个项目只存放两天)。
- 不但在本地域名服务器中需要高速缓存，在用户主机中也很需要。许多用户主机在启动时从本地域名服务器下载域名和IP地址的全部数据库，维护存放自己最近使用的域名的高速缓存，并且只在从缓存中找不到域名时才向域名服务器查询。同理，主机也需要保持高速缓存中内容的正确性。

![image-20221101162033005](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101162033005.png)



### 总结

![image-20221101162333186](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101162333186.png)



------



## 6.5、文件传送协议FTP

### 概念

- 将某台计算机中的文件通过网络传送到可能相距很远的另一台计算机中，是一项基本的网络应用，即文件传送。
- **文件传送协议FTP**(File Transfer Protocol）是因特网上使用得最广泛的文件传送协议
  - FTP**提供交互式的访问**，允许客户**指明文件的类型与格式**(如指明是否使用ASCII码)，并允许**文件具有存取权限**(如访问文件的用户必须经过授权，并输入有效的口令)。
  - **FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件**。
- 在因特网发展的早期阶段，用FTP传送文件约占整个因特网的通信量的三分之一，而由电子邮件和域名系统所产生的通信量还要小于FTP所产生的通信量。只是到了1995年，万维网WWW的通信量才首次超过了FTP。



### 文件传送协议FTP的应用

FTP采用C/S方式（客户/服务器方式）

FTP客户计算机可将各种类型的文件上传到FTP服务器计算机

![image-20221101162740973](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101162740973.png)

FTP客户计算机也可以从FTP服务器计算机下载文件

根据应用需求的不同，FTP服务器可能需要一台高性能和高可靠性的服务器计算机，也可能只需要一台普通的个人计算机即可。

![image-20221101163219006](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101163219006.png)

![image-20221101163056356](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101163056356.png)

- FTP的常见用途是在计算机之间传输文件，尤其是用于批量传输文件。
- FTP的另一个常见用途是让网站设计者将构成网站内容的大量文件批量上传到他们的Web服务器。

### FTP基本工作原理

FTP服务器监听熟知端口（端口号为 21），使客户进程能够连接上。

FTP客户随机选择一个临时端口号与其建立TCP连接，这条TCP连接用于FTP客户与服务器之间传送FTP的相关控制命令（这条连接是FTP客户与服务器之间的命令通道）

下图为建立数据通道的TCP连接

FTP服务器使用自己的熟知端口号20与其建立TCP连接，这条TCP连接用于FTP客户与服务器之间传送文件

![](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101163503721.png)

> 上面例子是主动模式：建立数据通道时，FTP服务器主动连接FTP客户

下图实例为被动模式

![image-20221101163620093](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101163620093.png)

> 注意两种模式都是
>
> 控制连接在整个会话期间保持打开状态
>
> 数据连接传输完毕后就关闭

- FTP客户和服务器之间要建立“控制连接”和“数据连接”这两个并行的TCP连接。控制连接在整个会话期间都保持打开状态，而数据连接在每次文件传输时才建立，传输结束就关闭。
- 默认情况下，FTP使用TCP21端口进行控制连接，TCP20端口进行数据连接。
- 但是，是否使用TCP 20端口建立数据连接与传输模式有关，主动方式使用TCP 20端口，被动方式由服务器和客户端自行协商决定。

### 总结

![image-20221101163832871](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101163832871.png)



------



## 6.6、电子邮件

### 概念

- 电子邮件（E-mail)是因特网上**最早流行的一种应用**，并且仍然是当今因特网上最重要、最实用的应用之一。
- 传统的电话通信属于实时通信，存在以下两个缺点:
  - 电话通信的主叫和被叫双方必须同时在场;
  - 一些不是十分紧迫的电话也常常不必要地打断人们的工作或休息。
- 而电子邮件与邮政系统的寄信相似。
  1. 发件人将邮件发送到自己使用的**邮件服务器**
  2. 发件人的邮件服务器将收到的邮件按其目的地址转发到收件人邮件服务器中的收件人邮箱
  3. 收件人在方便的时候访问收件人邮件服务器中自己的邮箱，获取收到的电子邮件。
- 电子邮件使用方便、传递迅速而且费用低廉。它不仅可以传送文字信息，而且还可附上声音和图像。
- 由于电子邮件的广泛使用，现在许多国家已经正式取消了电报业务。在我国，**电信局的电报业务也因电子邮件的普及而濒临消失**。



### 邮件发送和接收过程

- 电子邮件系统采用**客户/服务器方式**。
- 电子邮件系统的三个主要组成构件:**用户代理**，**邮件服务器**，以及**电子邮件所需的协议**。
  - **用户代理**是用户与电子邮件系统的接口，又称为**电子邮件客户端软件**。
  - **邮件服务器**是电孑邮件系统的基础设施。因特网上所有的ISP都有邮件服务器，其功能是**发送和接收邮件**，同时还要负责维护用户的邮箱。
  - **协议**包括邮件**发送协议**（例如SMTP）和邮件**读取协议**（例如POP3，IMAP)。

![image-20221101174728099](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101174728099.png)

### 简单邮件传送协议SMTP（Simple Mail Transfer Protocol）的基本工作原理

![image-20221101175118141](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101175118141.png)



### 电子邮件的信息格式

![image-20221101175346481](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101175346481.png)

- **SMTP协议只能传送ASCII码文本数据**，不能传送可执行文件或其他的二进制对象。
- SMTP不能满足传送多媒体邮件（例如带有图片、音频或视频数据）的需要。并且许多其他非英语国家的文字(例如中文、俄文、甚至带有重音符号的法文或德文)也无法用SMTP传送。
- 为解决SMTP传送非ASCII码文本的问题，提出了**多用途因特网邮件扩展MIME** (Mutipurpose Intermnet Mail Extensions)
  - 增加了**5个新的邮件首部字段**，这些字段提供了有关邮件主体的信息。
  - 定义了**许多邮件内容的格式**，对多媒体电子邮件的表示方法进行了标准化。
  - 定义了**传送编码**，可对任何内容格式进行转换，而不会被邮件系统改变。
- 实际上，MIME不仅仅用于SMTP，也用于后来的同样面向ASCII字符的HTTP。\

![image-20221101175511432](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101175511432.png)

### 邮件读取

- 常用的邮件读取协议有以下两个:
- **邮局协议POP** (Post Office Protocol),POP3是其第三个版本，是因特网正式标准。
  - 非常简单、功能有限的邮件读取协议。
  - 用户只能以**下载并删除方式**或**下载并保留方式**从邮件服务器下载邮件到用户方计算机。
  - **不允许用户在邮件服务器上管理自己的邮件**。(例如创建文件夹，对邮件进行分类管理等)。
- **因特网邮件访问协议IMAP** (Internet Message Access Protocol)，IMAP4是其第四个版本，目前还只是因特网建议标准。
  - 功能比POP3强大的邮件读取协议。
  - **用户在自己的计算机上就可以操控邮件服务器中的邮箱**，就像在本地操控━样，因此IMAP是一个联机协议。
- POP3和IMAP4都采用**基于TCP连接的客户/服务器方式**。POP3使用熟知端口110，IMAP4使用熟知端口143。

![image-20221101180112422](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101180112422.png)

### 基于万维网的电子邮件

- 通过**浏览器**登录(提供用户名和口令）**邮件服务器万维网网站**就可以撰写、收发、阅读和管理电子邮件。这种工作模式与IMAP很类似，不同的是用户计算机无需安装专门的用户代理程序，只需要使用通用的万维网浏览器。
- 邮件服务器网站通常都提供非常强大和方便的邮件管理功能，用户可以在邮件服务器网站上管理和处理自己的邮件，而不需要将邮件下载到本地进行管理。

![image-20221101180714726](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101180714726.png)



### 总结

![image-20221101181236532](C:\Users\yumo\AppData\Roaming\Typora\typora-user-images\image-20221101181236532.png)



------



## 6.7、万维网WWW

### 概念

**概述**

* **万维网** WWW (World Wide Web) 并非某种特殊的计算机网络。
* 万维网是一个大规模的、联机式的**信息储藏所**。
* 万维网用链接的方法能非常方便地从互联网上的一个站点访问另一个站点，从而主动地按需获取丰富的信息。
* 这种访问方式称为“**链接**”。

![image-20221101181601991](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101181601991.png)

**万维网的工作方式**

* 万维网以**客户 - 服务器**方式工作。
* **浏览器**就是在用户计算机上的万维网**客户程序**。万维网文档所驻留的计算机则运行**服务器程序**，因此这个计算机也称为**万维网服务器**。
* 客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的**万维网文档**。
* 在一个客户程序主窗口上显示出的万维网文档称为**页面** (page)。





**万维网应用举例**

访问网页

![image-20221101181710906](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101181710906.png)

**怎样标志分布在整个互联网上的万维网文档？**

![image-20221101181829817](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101181829817.png)

**万维网的文档**

![image-20221101181925492](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101181925492.png)

![image-20221101182003871](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101182003871.png)

![image-20221101182104190](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101182104190.png)





### 超文本传输协议HTTP（Hyper Transfer Protocol）

#### 概念和传输过程

* 在万维网客户程序与万维网服务器程序之间进行交互所使用的协议，是**超文本传送协议** HTTP (HyperText Transfer Protocol)。
* HTTP 是一个应用层协议，它使用 TCP 连接进行可靠的传送。 

![image-20221101182414215](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101182414215.png)



![image-20221101182547519](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101182547519.png)

- HTTP/1.0采用**非持续连接**方式。在该方式下，每次浏览器要请求一个文件都要与服务器建立TCP连接，当收到响应后就立即关闭连接。
  - 每请求一个文档就要有两倍的RTT的开销。若一个网页上有很多引用对象（例如图片等)，那么请求每一个对象都需要花费2RTT的时间。
  - 为了减小时延，浏览器通常会建立多个并行的TCP连接同时请求多个对象。但是，这会大量占用万维网服务器的资源，特别是万维网服务器往往要同时服务于大量客户的请求，这会使其负担很重。
- HTTP/1.1采用**持续连接**方式。在该方式下，万维网服务器在发送响应后仍然保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的HTTP请求报文和响应报文。这并不局限于传送同一个页面上引用的对象，而是只要这些文档都在同一个服务器上就行。
  - 为了进一步提高效率，HTTP/1.1的持续连接还可以使用**流水线**方式工作，即浏览器在收到HTTP的响应报文之前就能够连续发送多个请求报文。这样的一个接一个的请求报文到达服务器后服务器就发回一个接一个的响应报文。这样就节省了很多个RTT时间，使TCP连接中的空闲时间减少，提高了下载文档的效率。



#### HTTP报文格式

**HTTP请求报文格式**

![image-20221101183010999](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183010999.png)

![image-20221101183035771](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183035771.png)

**HTTP响应报文格式**

![image-20221101183117265](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183117265.png)

![image-20221101183206287](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183206287.png)

#### 使用Cookie在服务器上记录用户信息

- 使用Cookie在服务器上记录用户信息
- 早期的万维网应用非常简单，仅仅是用户查看存放在不同服务器上的各种静态的文档。因此HTTP被设计为一种**无状态**的协议。这样可以简化服务器的设计。
- 现在，用户可以通过万维网实现各种复杂的应用，如网上购物、电子商务等。这些应用往往需要万维网服务器能够识别用户。
- Cookie提供了一种机制使得万维网服务器能够“记住”用户，而无需用户主动提供用户标识信息。也就是说，**Cookie是一种对无状态的HTTP进行状态化的技术**。

![image-20201024224945200](E:\学习笔记\计算机网络\计算机网络第6章（应用层）.assets\image-20201024224945200.png)

![image-20221101183321269](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183321269.png)

![image-20221101183457494](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183457494.png)





#### 万维网缓存与代理服务器

- 万维网缓存与代理服务器
  - 在万维网中还可以使用缓存机制以提高万维网的效率。
  - 万维网缓存又称为**Web缓存**(Web Cache)，可位于客户机，也可位于中间系统上，位于中间系统上的Web缓存又称为**代理服务器**(Proxy Server) 。
  - Web缓存把最近的一些请求和响应暂存在本地磁盘中。**当新请求到达时，若发现这个请求与暂时存放的请求相同，就返回暂存的响应，而不需要按URL的地址再次去因特网访问该资源**。

如果该请求有缓存

![image-20221101183827375](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183827375.png)

如果该请求没有缓存

![image-20221101183750976](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183750976.png)

> 若Web缓存的命中率比较高
>
> 则会大大减小了该链路上的通信量，因而减少了访问因特网的时延

假设原始服务器的文档被更改，这样代理服务器的文档就不是最新的

所以原始服务器通常会为每个响应的对象设定一个**修改时间字段**和一个**有效日期字段**

若未过期

![image-20221101183941896](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101183941896.png)

若过期并且代理服务器的文档和原始服务器的**文档一致**，原始服务器则给代理服务器发送不包含实体主体的响应

![image-20221101184030003](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101184030003.png)

若过期并且代理服务器的文档和原始服务器的**文档不一致**，原始服务器则给代理服务器发送封装有该文档的响应报文 

![image-20221101184051478](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101184051478.png)



### 总结

![image-20221101184524618](https://yumoimgbed.oss-cn-shenzhen.aliyuncs.com/img/image-20221101184524618.png)
